<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack原理 | 小鱼儿的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="专注前端技术栈分享,从前端到Node.js再到数据库">
    
    <link rel="preload" href="/fish-vuePress/assets/css/0.styles.af3f7b63.css" as="style"><link rel="preload" href="/fish-vuePress/assets/js/app.df5f89c4.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/5.edcfac08.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/2.3e0c97ad.js" as="script"><link rel="prefetch" href="/fish-vuePress/assets/js/10.b77df3ea.js"><link rel="prefetch" href="/fish-vuePress/assets/js/100.a0d590cb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/101.0c4817e4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/102.78764042.js"><link rel="prefetch" href="/fish-vuePress/assets/js/103.a96d5da9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/104.a28a3fb7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/105.2cec88b8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/106.e18e3f35.js"><link rel="prefetch" href="/fish-vuePress/assets/js/107.3744efd2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/108.ced67a25.js"><link rel="prefetch" href="/fish-vuePress/assets/js/109.f57e1134.js"><link rel="prefetch" href="/fish-vuePress/assets/js/11.97b74358.js"><link rel="prefetch" href="/fish-vuePress/assets/js/110.7c61f586.js"><link rel="prefetch" href="/fish-vuePress/assets/js/111.8e889bff.js"><link rel="prefetch" href="/fish-vuePress/assets/js/112.39a52113.js"><link rel="prefetch" href="/fish-vuePress/assets/js/113.dae7f961.js"><link rel="prefetch" href="/fish-vuePress/assets/js/114.2d597a8d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/115.9553737f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/116.063d8847.js"><link rel="prefetch" href="/fish-vuePress/assets/js/117.13e26da9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/118.3529b5be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/119.8792b07b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/12.3ecb1de5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/120.ed65532d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/121.8c4731cc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/122.4d92baeb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/123.210e85e7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/124.1e513801.js"><link rel="prefetch" href="/fish-vuePress/assets/js/125.d9e5ebae.js"><link rel="prefetch" href="/fish-vuePress/assets/js/126.107bfe67.js"><link rel="prefetch" href="/fish-vuePress/assets/js/127.14edacab.js"><link rel="prefetch" href="/fish-vuePress/assets/js/128.888bc9d6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/129.92bb5f4a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/13.824408f4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/130.e9dca7f9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/131.6bc5662c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/132.1bfdc2ca.js"><link rel="prefetch" href="/fish-vuePress/assets/js/133.99f9ca2f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/134.69c60897.js"><link rel="prefetch" href="/fish-vuePress/assets/js/135.85a830bc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/136.b5627c7c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/137.bcadb89c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/14.ebcb0a05.js"><link rel="prefetch" href="/fish-vuePress/assets/js/15.d3a0b0df.js"><link rel="prefetch" href="/fish-vuePress/assets/js/16.92300b13.js"><link rel="prefetch" href="/fish-vuePress/assets/js/17.e7cd0ca8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/18.9b1b98e6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/19.a6853cc0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/20.eb68a5fa.js"><link rel="prefetch" href="/fish-vuePress/assets/js/21.b3e94a5d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/22.7e6803a4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/23.7a26abb3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/24.3a0e2284.js"><link rel="prefetch" href="/fish-vuePress/assets/js/25.2f09a139.js"><link rel="prefetch" href="/fish-vuePress/assets/js/26.fdd61db3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/27.88ee342e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/28.2dba197d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/29.0b89f09e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/3.961388cf.js"><link rel="prefetch" href="/fish-vuePress/assets/js/30.0b4504ec.js"><link rel="prefetch" href="/fish-vuePress/assets/js/31.35a942d3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/32.f6f62b31.js"><link rel="prefetch" href="/fish-vuePress/assets/js/33.1fce904f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/34.86a7f705.js"><link rel="prefetch" href="/fish-vuePress/assets/js/35.a0d3c71e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/36.d4aa17d5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/37.e84a19da.js"><link rel="prefetch" href="/fish-vuePress/assets/js/38.5a3d6630.js"><link rel="prefetch" href="/fish-vuePress/assets/js/39.72e8a86b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/4.deb713bc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/40.171e086b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/41.3d3d2a08.js"><link rel="prefetch" href="/fish-vuePress/assets/js/42.1b56fbe9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/43.55d66008.js"><link rel="prefetch" href="/fish-vuePress/assets/js/44.1f65c599.js"><link rel="prefetch" href="/fish-vuePress/assets/js/45.bd0206b1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/46.aafec962.js"><link rel="prefetch" href="/fish-vuePress/assets/js/47.ac94a28e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/48.2a025aa5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/49.469aaa8c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/50.08274f17.js"><link rel="prefetch" href="/fish-vuePress/assets/js/51.9b109d30.js"><link rel="prefetch" href="/fish-vuePress/assets/js/52.85094941.js"><link rel="prefetch" href="/fish-vuePress/assets/js/53.610ff2c3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/54.1441c891.js"><link rel="prefetch" href="/fish-vuePress/assets/js/55.b8bbb84d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/56.440ddff2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/57.844af420.js"><link rel="prefetch" href="/fish-vuePress/assets/js/58.3394b61f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/59.5e352a87.js"><link rel="prefetch" href="/fish-vuePress/assets/js/6.81d396d4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/60.5ae989c0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/61.0864cf11.js"><link rel="prefetch" href="/fish-vuePress/assets/js/62.c7442a3b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/63.d893bc29.js"><link rel="prefetch" href="/fish-vuePress/assets/js/64.6da0341b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/65.e2789671.js"><link rel="prefetch" href="/fish-vuePress/assets/js/66.5b4f4293.js"><link rel="prefetch" href="/fish-vuePress/assets/js/67.a0798723.js"><link rel="prefetch" href="/fish-vuePress/assets/js/68.53f11a09.js"><link rel="prefetch" href="/fish-vuePress/assets/js/69.63cb2a8a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/7.6897ca43.js"><link rel="prefetch" href="/fish-vuePress/assets/js/70.804547f9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/71.5787158b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/72.946799be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/73.9d9e52b5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/74.28bafc8a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/75.bd946076.js"><link rel="prefetch" href="/fish-vuePress/assets/js/76.a566a607.js"><link rel="prefetch" href="/fish-vuePress/assets/js/77.3e7bfce0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/78.ec1d52b5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/79.492d0e3b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/8.49a8a0b3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/80.f68ea700.js"><link rel="prefetch" href="/fish-vuePress/assets/js/81.a15fa2be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/82.786ff7c0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/83.6b9d4900.js"><link rel="prefetch" href="/fish-vuePress/assets/js/84.48c296d1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/85.567505d3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/86.1b6fdd4e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/87.90cefee1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/88.f7c32624.js"><link rel="prefetch" href="/fish-vuePress/assets/js/89.0f22b52a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/9.7a3a195f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/90.b23071bb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/91.9b06412d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/92.44c6f292.js"><link rel="prefetch" href="/fish-vuePress/assets/js/93.ced630dd.js"><link rel="prefetch" href="/fish-vuePress/assets/js/94.c5d880af.js"><link rel="prefetch" href="/fish-vuePress/assets/js/95.7ea00f99.js"><link rel="prefetch" href="/fish-vuePress/assets/js/96.08a9387a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/97.7cf3b129.js"><link rel="prefetch" href="/fish-vuePress/assets/js/98.92843a37.js"><link rel="prefetch" href="/fish-vuePress/assets/js/99.3fad2047.js">
    <link rel="stylesheet" href="/fish-vuePress/assets/css/0.styles.af3f7b63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fish-vuePress/" class="home-link router-link-active"><!----> <span class="site-name">小鱼儿的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link router-link-active">
  webpack
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link router-link-active">
  webpack
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fish-vuePress/webpack/webpack原理.html" class="active sidebar-link">webpack原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#webpack原理" class="sidebar-link">webpack原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-webpack插件机制" class="sidebar-link">1.webpack插件机制</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-tapable分类" class="sidebar-link">2.tapable分类</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#sync-类型的钩子" class="sidebar-link">Sync 类型的钩子</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1、synchook" class="sidebar-link">1、SyncHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3、syncwaterfallhook" class="sidebar-link">3、SyncWaterfallHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4、syncloophook" class="sidebar-link">4、SyncLoopHook</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#async-类型的钩子" class="sidebar-link">Async 类型的钩子</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1、asyncparallelhook" class="sidebar-link">1、AsyncParallelHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-tapasync-callasync" class="sidebar-link" style="padding-left:3rem;">(1) tapAsync/callAsync</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-tappromise-promise" class="sidebar-link" style="padding-left:3rem;">(2) tapPromise/promise</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2、asyncserieshook" class="sidebar-link">2、AsyncSeriesHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-tapasync-callasync-2" class="sidebar-link" style="padding-left:3rem;">(1) tapAsync/callAsync</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-tappromise-promise-2" class="sidebar-link" style="padding-left:3rem;">(2) tapPromise/promise</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#对其他异步钩子补充" class="sidebar-link">对其他异步钩子补充</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-synchook" class="sidebar-link">3.syncHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-syncbailhook" class="sidebar-link">4.SyncBailHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_5-syncwaterfallhook" class="sidebar-link">5.SyncWaterfallHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-syncloophook" class="sidebar-link">6.SyncLoopHook</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-asyncparallk" class="sidebar-link">7.AsyncParallk</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#image-20201202203316845-vuepress-public-webpack-image-20201202203316845-png" class="sidebar-link">!image-20201202203316845</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_12-intercept" class="sidebar-link">12.intercept</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_13-context" class="sidebar-link">13.context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_14-代码块" class="sidebar-link">14.代码块</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#工作流程" class="sidebar-link">工作流程</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#loader的整体流程" class="sidebar-link">loader的整体流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-loader配置" class="sidebar-link">1.loader配置</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-loader用法" class="sidebar-link">3.loader用法</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-用法准则" class="sidebar-link">4.用法准则</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_5-loader类型" class="sidebar-link">5.loader类型</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-loader如何执行的" class="sidebar-link">6. loader如何执行的</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-loader-api" class="sidebar-link">7.loader api</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-1-this-cacheabe" class="sidebar-link" style="padding-left:3rem;">7-1.this.cacheabe</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-2-thia-async" class="sidebar-link" style="padding-left:3rem;">7-2.thia.async</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-3-thia-callback" class="sidebar-link" style="padding-left:3rem;">7-3.thia.callback</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-4-loader-raw" class="sidebar-link" style="padding-left:3rem;">7-4.loader.raw</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_8-loader-其他api" class="sidebar-link">8.loader-其他api</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_9-raw-loader" class="sidebar-link">9.raw-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#pitch" class="sidebar-link">pitch</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#run-loader源码" class="sidebar-link">Run-loader源码</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#自模拟实现的loader" class="sidebar-link">自模拟实现的loader</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-babel-loader" class="sidebar-link">1.babel-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-banner-loader" class="sidebar-link">2.banner-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-style-loader" class="sidebar-link">3.style-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-css-loader" class="sidebar-link">4.Css-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_5-file-loader" class="sidebar-link">5.file-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-url-loader" class="sidebar-link">6.url-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-sprite-loader" class="sidebar-link">7.sprite-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_8-px2rem-loader" class="sidebar-link">8.px2rem-loader</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#loader-utils看官方文档" class="sidebar-link">看官方文档</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#plugin" class="sidebar-link">plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-plugin" class="sidebar-link">1.plugin</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-创建插件" class="sidebar-link">2.创建插件</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-基本插件架构" class="sidebar-link">3.基本插件架构</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-预获取插件" class="sidebar-link">4.预获取插件</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#npx-webpack-profile-json-stats-json" class="sidebar-link">npx webpack --profile --json &gt; stats.json</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_5-done-plugin" class="sidebar-link">5.done-plugin</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-optimizeplugin" class="sidebar-link">6.OptimizePlugin</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-zipplugin" class="sidebar-link">7.ZipPlugin</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_8-自动外链" class="sidebar-link">8.自动外链</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_9-自动上传到cdn" class="sidebar-link">9.自动上传到cdn</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#ast" class="sidebar-link">AST</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#懒加载" class="sidebar-link">懒加载</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#热更新" class="sidebar-link">热更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-服务端" class="sidebar-link">1.服务端</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-客户端" class="sidebar-link">2.客户端</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#进阶" class="sidebar-link">进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-使用" class="sidebar-link">1. 使用</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-自定义loader的查找规则" class="sidebar-link">2.自定义loader的查找规则</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-loader的标准" class="sidebar-link">3. loader的标准</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-loader类型" class="sidebar-link">4. loader类型</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-pre-前置loader" class="sidebar-link" style="padding-left:3rem;">1.pre-前置loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-normal-正常loader" class="sidebar-link" style="padding-left:3rem;">2.normal-正常loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-inline-行内loader" class="sidebar-link" style="padding-left:3rem;">3.inline-行内loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-post-后置loader" class="sidebar-link" style="padding-left:3rem;">4.post-后置loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-loaders的常见api" class="sidebar-link">6. loaders的常见API</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-this-callback" class="sidebar-link" style="padding-left:3rem;">1. this.callback</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-越过loader-pitching-loader" class="sidebar-link" style="padding-left:3rem;">2. 越过loader(Pitching loader)</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-raw" class="sidebar-link" style="padding-left:3rem;">3. raw</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-loader工具库中常见方法" class="sidebar-link">7. loader工具库中常见方法</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-loaderutils-stringifyrequest-this-itemurl" class="sidebar-link" style="padding-left:3rem;">1. loaderUtils.stringifyRequest(this, itemUrl)</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-loaderutils-getoptions-this" class="sidebar-link" style="padding-left:3rem;">2. loaderUtils.getOptions(this)</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-schemautils-schema-options" class="sidebar-link" style="padding-left:3rem;">3. schemaUtils(schema, options)</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_8-自模拟实现loader" class="sidebar-link">8.自模拟实现loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_1-babel-loader-2" class="sidebar-link" style="padding-left:3rem;">1. babel-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_2-banner-loader-2" class="sidebar-link" style="padding-left:3rem;">2. banner-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_3-less-loader" class="sidebar-link" style="padding-left:3rem;">3. less-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_4-css-loader-2" class="sidebar-link" style="padding-left:3rem;">4. css-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_5-style-loader" class="sidebar-link" style="padding-left:3rem;">5.style-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_6-file-loader" class="sidebar-link" style="padding-left:3rem;">6. file-loader</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/webpack/webpack原理.html#_7-url-loader" class="sidebar-link" style="padding-left:3rem;">7.url-loader</a></li></ul></li></ul></li><li><a href="/fish-vuePress/webpack/base.html" class="sidebar-link">webpack基础</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="webpack原理"><a href="#webpack原理" class="header-anchor">#</a> webpack原理</h2> <h3 id="_1-webpack插件机制"><a href="#_1-webpack插件机制" class="header-anchor">#</a> 1.webpack插件机制</h3> <p><img src="/fish-vuePress/assets/img/image-20201201184742932.1f86dd48.png" alt="image-20201201184742932"></p> <h3 id="_2-tapable分类"><a href="#_2-tapable分类" class="header-anchor">#</a> 2.tapable分类</h3> <p><img src="/fish-vuePress/assets/img/image-20201201185400154.84516253.png" alt="image-20201201185400154"></p> <p><img src="/fish-vuePress/assets/img/image-20201202225518704.c8372bdb.png" alt="image-20201202225518704"></p> <p>Webpack 本质上是一种事件流的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是 <code>tapable</code>，Webpack 中最核心的，负责编译的 <code>Compiler</code> 和负责创建 <code>bundles</code> 的 <code>Compilation</code> 都是 <code>tapable</code> 构造函数的实例。</p> <p>打开 Webpack <code>4.0</code> 的源码中一定会看到下面这些以 <code>Sync</code>、<code>Async</code> 开头，以 <code>Hook</code> 结尾的方法，这些都是 <code>tapable</code> 核心库的类，为我们提供不同的事件流执行机制，我们称为 “钩子”。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 引入 tapable 如下</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    SyncHook<span class="token punctuation">,</span>
    SyncBailHook<span class="token punctuation">,</span>
    SyncWaterfallHook<span class="token punctuation">,</span>
    SyncLoopHook<span class="token punctuation">,</span>
    AsyncParallelHook<span class="token punctuation">,</span>
    AsyncParallelBailHook<span class="token punctuation">,</span>
    AsyncSeriesHook<span class="token punctuation">,</span>
    AsyncSeriesBailHook<span class="token punctuation">,</span>
    AsyncSeriesWaterfallHook
 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li></li></ul> <p>上面的实现事件流机制的 “钩子” 大方向可以分为两个类别，“同步” 和 “异步”，“异步” 又分为两个类别，“并行” 和 “串行”，而 “同步” 的钩子都是串行的。</p> <h2 id="sync-类型的钩子"><a href="#sync-类型的钩子" class="header-anchor">#</a> Sync 类型的钩子</h2> <h3 id="_1、synchook"><a href="#_1、synchook" class="header-anchor">#</a> 1、SyncHook</h3> <p>SyncHook 为串行同步执行，不关心事件处理函数的返回值，在触发事件之后，会按照事件注册的先后顺序执行所有的事件处理函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// SyncHook 钩子的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> syncHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
syncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
syncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
syncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
<span class="token function">syncHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18</span>
<span class="token comment">// 2 panda 18</span>
<span class="token comment">// 3 panda 18</span>
</code></pre></div><p>在 <code>tapable</code> 解构的 <code>SyncHook</code> 是一个类，注册事件需先创建实例，创建实例时支持传入一个数组，数组内存储事件触发时传入的参数，实例的 <code>tap</code> 方法用于注册事件，支持传入两个参数，第一个参数为事件名称，在 Webpack 中一般用于存储事件对应的插件名称（名字随意，只是起到注释作用）， 第二个参数为事件处理函数，函数参数为执行 <code>call</code> 方法触发事件时所传入的参数的形参。</p> <p>模拟 SyncHook 类</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 也可在参数不足时抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;参数不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 依次执行事件处理函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">

</span><span class="token template-punctuation string">`</span></span>tasks<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 数组用于存储事件处理函数，</span><span class="token template-punctuation string">`</span></span>call<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 方法调用时传入参数超过创建 </span><span class="token template-punctuation string">`</span></span>SyncHook<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 实例传入的数组长度时，多余参数可处理为 </span><span class="token template-punctuation string">`</span></span><span class="token keyword">undefined</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">，也可在参数不足时抛出异常，不灵活，后面的例子中就不再这样写了。

### 2、SyncBailHook

</span><span class="token template-punctuation string">`</span></span>SyncBailHook<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> 同样为串行同步执行，如果事件处理函数执行时有一个返回值不为空（即返回值为 </span><span class="token template-punctuation string">`</span></span><span class="token keyword">undefined</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">），则跳过剩下未执行的事件处理函数（如类的名字，意义在于保险）。

只要返回一个不为undefined 的值 就不执行后续 的

</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>js
<span class="token comment">// SyncBailHook 钩子的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> syncBailHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
syncBailHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncBailHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncBailHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
<span class="token function">syncBailHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18</span>
<span class="token comment">// 2 panda 18</span>
复制代码
</code></pre></div><p>通过上面的用法可以看出，<code>SyncHook</code> 和 <code>SyncBailHook</code> 在逻辑上只是 <code>call</code> 方法不同，导致事件的执行机制不同，对于后面其他的 “钩子”，也是 <code>call</code> 的区别，接下来实现 <code>SyncBailHook</code> 类。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 SyncBailHook 类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncBailHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 依次执行事件处理函数，如果返回值不为空，则停止向下执行</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面代码的 <code>call</code> 方法中，我们设置返回值为 <code>ret</code>，第一次执行后没有返回值则继续循环执行，如果有返回值则立即停止循环，即实现 “保险” 的功能。</p> <h3 id="_3、syncwaterfallhook"><a href="#_3、syncwaterfallhook" class="header-anchor">#</a> 3、SyncWaterfallHook</h3> <p><code>SyncWaterfallHook</code> 为串行同步执行，上一个事件处理函数的返回值作为参数传递给下一个事件处理函数，依次类推，正因如此，只有第一个事件处理函数的参数可以通过 <code>call</code> 传递，而 <code>call</code> 的返回值为最后一个事件处理函数的返回值。</p> <p>如果上一个函数有返回值 则传给下一个函数 如果没有返回值 则找上一个函数的返回值</p> <div class="language-typescript jsx extra-class"><pre class="language-typescript"><code><span class="token comment">// SyncWaterfallHook 钩子的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> syncWaterfallHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
syncWaterfallHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncWaterfallHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncWaterfallHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
<span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">syncWaterfallHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;call&quot;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18</span>
<span class="token comment">// 2 1</span>
<span class="token comment">// 3 2</span>
<span class="token comment">// call 3</span>
</code></pre></div><p><code>SyncWaterfallHook</code> 名称中含有 “瀑布”，通过上面代码可以看出 “瀑布” 形象生动的描绘了事件处理函数执行的特点，与 <code>SyncHook</code> 和 <code>SyncBailHook</code> 的区别就在于事件处理函数返回结果的流动性，接下来看一下 <code>SyncWaterfallHook</code> 类的实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 SyncWaterfallHook 类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncWaterfallHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 依次执行事件处理函数，事件处理函数的返回值作为下一个事件处理函数的参数</span>
        <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">...</span>others<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ret<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>上面代码中 <code>call</code> 的逻辑是将存储事件处理函数的 <code>tasks</code> 拆成两部分，分别为第一个事件处理函数，和存储其余事件处理函数的数组，使用 <code>reduce</code> 进行归并，将第一个事件处理函数执行后的返回值作为归并的初始值，依次调用其余事件处理函数并传递上一次归并的返回值。</p> <h3 id="_4、syncloophook"><a href="#_4、syncloophook" class="header-anchor">#</a> 4、SyncLoopHook</h3> <p><code>SyncLoopHook</code> 为串行同步执行，事件处理函数返回 <code>true</code> 表示继续循环，即循环执行当前事件处理函数，返回 <code>undefined</code> 表示结束循环，<code>SyncLoopHook</code> 与 <code>SyncBailHook</code> 的循环不同，<code>SyncBailHook</code> 只决定是否继续向下执行后面的事件处理函数，而 <code>SyncLoopHook</code> 的循环是指循环执行每一个事件处理函数，直到返回 <code>undefined</code> 为止，才会继续向下执行其他事件处理函数，执行机制同理。</p> <p>注意 如果返回的不是undefined 则函数重头再执行一遍</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// SyncLoopHook 钩子的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> syncLoopHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义辅助变量</span>
<span class="token keyword">let</span> total1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> total2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
syncLoopHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> total1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> total1<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncLoopHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> total2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> total2<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

syncLoopHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
<span class="token function">syncLoopHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18 0</span>
<span class="token comment">// 1 panda 18 1</span>
<span class="token comment">// 1 panda 18 2</span>
<span class="token comment">// 2 panda 18 0</span>
<span class="token comment">// 2 panda 18 1</span>
<span class="token comment">// 2 panda 18 2</span>
<span class="token comment">// 3 panda 18</span>

</code></pre></div><p>*<strong>通过上面的执行结果可以清楚的看到 <code>SyncLoopHook</code> 的执行机制，但有一点需要注意，返回值必须严格是 <code>true</code> 才会触发循环，多次执行当前事件处理函数，必须严格返回 <code>undefined</code>，才会结束循环，去执行后面的事件处理函数，如果事件处理函数的返回值不是 <code>true</code> 也不是 <code>undefined</code>，则会死循环。*</strong></p> <p>在了解 <code>SyncLoopHook</code> 的执行机制以后，我们接下来看看 <code>SyncLoopHook</code> 的 <code>call</code> 方法是如何实现的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 SyncLoopHook 类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncLoopHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 依次执行事件处理函数，如果返回值为 true，则继续执行当前事件处理函数</span>
        <span class="token comment">// 直到返回 undefined，则继续向下执行其他事件处理函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>ret <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>在上面代码中可以看到 <code>SyncLoopHook</code> 类 <code>call</code> 方法的实现更像是 <code>SyncHook</code> 和 <code>SyncBailHook</code> 的 <code>call</code> 方法的结合版，外层循环整个 <code>tasks</code> 事件处理函数队列，内层通过返回值进行循环，控制每一个事件处理函数的执行次数。</p> <p>*<strong>注意：在 Sync 类型 “钩子” 下执行的插件都是顺序执行的，只能使用 <code>tab</code> 注册。*</strong></p> <hr> <h2 id="async-类型的钩子"><a href="#async-类型的钩子" class="header-anchor">#</a> Async 类型的钩子</h2> <p>*<strong><code>Async</code> 类型可以使用 <code>tap</code>、<code>tapSync</code> 和 <code>tapPromise</code> 注册不同类型的插件 “钩子”，分别通过 <code>call</code>、<code>callAsync</code> 和 <code>promise</code> 方法调用，我们下面会针对 <code>AsyncParallelHook</code> 和 <code>AsyncSeriesHook</code> 的 <code>async</code> 和 <code>promise</code> 两种方式分别介绍和模拟。*</strong></p> <h3 id="_1、asyncparallelhook"><a href="#_1、asyncparallelhook" class="header-anchor">#</a> 1、AsyncParallelHook</h3> <p><code>AsyncParallelHook</code> 为异步并行执行，通过 <code>tapAsync</code> 注册的事件，通过 <code>callAsync</code> 触发，通过 <code>tapPromise</code> 注册的事件，通过 <code>promise</code> 触发（返回值可以调用 <code>then</code> 方法）。</p> <h4 id="_1-tapasync-callasync"><a href="#_1-tapasync-callasync" class="header-anchor">#</a> (1) tapAsync/callAsync</h4> <p><code>callAsync</code> 的最后一个参数为回调函数，在所有事件处理函数执行完毕后执行。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// AsyncParallelHook 钩子：tapAsync/callAsync 的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> asyncParallelHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
asyncParallelHook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18 2018-08-07T10:38:32.675Z</span>
<span class="token comment">// 2 panda 18 2018-08-07T10:38:33.674Z</span>
<span class="token comment">// 3 panda 18 2018-08-07T10:38:34.674Z</span>
<span class="token comment">// complete</span>
<span class="token comment">// time: 3005.060ms</span>
</code></pre></div><p>*<strong>异步并行是指，事件处理函数内三个定时器的异步操作最长时间为 <code>3s</code>，而三个事件处理函数执行完成总共用时接近 <code>3s</code>，所以三个事件处理函数是几乎同时执行的，不需等待。*</strong></p> <p>所有 <code>tabAsync</code> 注册的事件处理函数最后一个参数都为一个回调函数 <code>done</code>，每个事件处理函数在异步代码执行完毕后调用 <code>done</code> 函数，则可以保证 <code>callAsync</code> 会在所有异步函数都执行完毕后执行，接下来看一看 <code>callAsync</code> 是如何实现的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 AsyncParallelHook 类：tapAsync/callAsync</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tabAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先取出最后传入的回调函数</span>
        <span class="token keyword">let</span> finalCallback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定义一个 i 变量和 done 函数，每次执行检测 i 值和队列长度，决定是否执行 callAsync 的回调函数</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 依次执行事件处理函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>callAsync</code> 中，将最后一个参数（所有事件处理函数执行完毕后执行的回调）取出，并定义 <code>done</code> 函数，通过比较 <code>i</code> 和存储事件处理函数的数组 <code>tasks</code> 的 <code>length</code> 来确定回调是否执行，循环执行每一个事件处理函数并将 <code>done</code> 作为最后一个参数传入，所以每个事件处理函数内部的异步操作完成时，执行 <code>done</code> 就是为了检测是不是该执行 <code>callAsync</code> 的回调，当所有事件处理函数均执行完毕满足 <code>done</code> 函数内部 <code>i</code> 和 <code>length</code> 相等的条件时，则调用 <code>callAsync</code> 的回调。</p> <h4 id="_2-tappromise-promise"><a href="#_2-tappromise-promise" class="header-anchor">#</a> (2) tapPromise/promise</h4> <p>要使用 <code>tapPromise</code> 注册事件，对事件处理函数有一个要求，必须返回一个 Promise 实例，而 <code>promise</code> 方法也返回一个 Promise 实例，<code>callAsync</code> 的回调函数在 <code>promise</code> 方法中用 <code>then</code> 的方式代替。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// AsyncParallelHook 钩子：tapPromise/promise 的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> asyncParallelHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
asyncParallelHook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18 2018-08-07T12:17:21.741Z</span>
<span class="token comment">// 2 panda 18 2018-08-07T12:17:22.736Z</span>
<span class="token comment">// 3 panda 18 2018-08-07T12:17:23.739Z</span>
<span class="token comment">// time: 3006.542ms</span>
<span class="token comment">// [ '1', '2', '3' ]</span>
</code></pre></div><p>上面每一个 <code>tapPromise</code> 注册事件的事件处理函数都返回一个 Promise 实例，并将返回值传入 <code>resolve</code> 方法，调用 <code>promise</code> 方法触发事件时，如果所有事件处理函数返回的 Promise 实例结果都成功，会将结果存储在数组中，并作为参数传递给 <code>promise</code> 的 <code>then</code> 方法中成功的回调，如果有一个失败就是将失败的结果返回作为参数传递给失败的回调。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 AsyncParallelHook 类 tapPromise/promise</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将所有事件处理函数转换成 Promise 实例，并发执行所有的 Promise</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>其实根据上面对于 <code>tapPromise</code> 和 <code>promise</code> 使用的描述就可以猜到，<code>promise</code> 方法的逻辑是通过 <code>Promise.all</code> 来实现的。</p> <h3 id="_2、asyncserieshook"><a href="#_2、asyncserieshook" class="header-anchor">#</a> 2、AsyncSeriesHook</h3> <p><code>AsyncSeriesHook</code> 为异步串行执行，与 <code>AsyncParallelHook</code> 相同，通过 <code>tapAsync</code> 注册的事件，通过 <code>callAsync</code> 触发，通过 <code>tapPromise</code> 注册的事件，通过 <code>promise</code> 触发，可以调用 <code>then</code> 方法。</p> <h4 id="_1-tapasync-callasync-2"><a href="#_1-tapasync-callasync-2" class="header-anchor">#</a> (1) tapAsync/callAsync</h4> <p>与 <code>AsyncParallelHook</code> 的 <code>callAsync</code> 方法类似，<code>AsyncSeriesHook</code> 的 <code>callAsync</code> 方法也是通过传入回调函数的方式，在所有事件处理函数执行完毕后执行 <code>callAsync</code> 的回调函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// AsyncSeriesHook 钩子：tapAsync/callAsync 的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> asyncSeriesHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
asyncSeriesHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncSeriesHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncSeriesHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
asyncSeriesHook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 1 panda 18 2018-08-07T14:40:52.896Z</span>
<span class="token comment">// 2 panda 18 2018-08-07T14:40:54.901Z</span>
<span class="token comment">// 3 panda 18 2018-08-07T14:40:57.901Z</span>
<span class="token comment">// complete</span>
<span class="token comment">// time: 6008.790ms</span>
复制代码
</code></pre></div><p>*<strong>异步串行是指，事件处理函数内三个定时器的异步执行时间分别为 <code>1s</code>、<code>2s</code> 和 <code>3s</code>，而三个事件处理函数执行完总共用时接近 <code>6s</code>，所以三个事件处理函数执行是需要排队的，必须一个一个执行，当前事件处理函数执行完才能执行下一个。*</strong></p> <p><code>AsyncSeriesHook</code> 类的 <code>tabAsync</code> 方法注册的事件处理函数参数中的 <code>next</code> 可以与 <code>AsyncParallelHook</code> 类中 <code>tabAsync</code> 方法参数的 <code>done</code> 进行类比，同为回调函数，不同点在于 <code>AsyncSeriesHook</code> 与 <code>AsyncParallelHook</code> 的 <code>callAsync</code> 方法的 “并行” 和 “串行” 的实现方式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 AsyncSeriesHook 类：tapAsync/callAsync</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tabAsync</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先取出最后传入的回调函数</span>
        <span class="token keyword">let</span> finalCallback <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定义一个 i 变量和 next 函数，每次取出一个事件处理函数执行，并维护 i 的值</span>
        <span class="token comment">// 直到所有事件处理函数都执行完，调用 callAsync 的回调</span>
        <span class="token comment">// 如果事件处理函数中没有调用 next，则无法继续</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            task <span class="token operator">?</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p><code>AsyncParallelHook</code> 是通过循环依次执行了所有的事件处理函数，<code>done</code> 方法只为了检测是否已经满足条件执行 <code>callAsync</code> 的回调，如果中间某个事件处理函数没有调用 <code>done</code>，只是不会调用 <code>callAsync</code> 的回调，但是所有的事件处理函数都执行了。</p> <p>而 <code>AsyncSeriesHook</code> 的 <code>next</code> 执行机制更像 <code>Express</code> 和 <code>Koa</code> 中的中间件，在注册事件的回调中如果不调用 <code>next</code>，则在触发事件时会在没有调用 <code>next</code> 的事件处理函数的位置 “卡死”，即不会继续执行后面的事件处理函数，只有都调用 <code>next</code> 才能继续，而最后一个事件处理函数中调用 <code>next</code> 决定是否调用 <code>callAsync</code> 的回调。</p> <h4 id="_2-tappromise-promise-2"><a href="#_2-tappromise-promise-2" class="header-anchor">#</a> (2) tapPromise/promise</h4> <p>与 <code>AsyncParallelHook</code> 类似，<code>tapPromise</code> 注册事件的事件处理函数需要返回一个 Promise 实例，<code>promise</code> 方法最后也返回一个 Promise 实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// AsyncSeriesHook 钩子：tapPromise/promise 的使用</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">let</span> asyncSeriesHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
asyncSeriesHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncSeriesHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncParallelHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件，让监听函数执行</span>
asyncSeriesHook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">&quot;panda&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">ret</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1 panda 18 2018-08-07T14:45:52.896Z</span>
<span class="token comment">// 2 panda 18 2018-08-07T14:45:54.901Z</span>
<span class="token comment">// 3 panda 18 2018-08-07T14:45:57.901Z</span>
<span class="token comment">// time: 6014.291ms</span>
<span class="token comment">// [ '1', '2', '3' ]</span>
复制代码
</code></pre></div><p>分析上面的执行过程，所有的事件处理函数都返回了 Promise 的实例，如果想实现 “串行”，则需要让每一个返回的 Promise 实例都调用 <code>then</code>，并在 <code>then</code> 中执行下一个事件处理函数，这样就保证了只有上一个事件处理函数执行完后才会执行下一个。</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">// 模拟 AsyncSeriesHook 类 tapPromise/promise</span>
<span class="token keyword">class</span> AsyncSeriesHook <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入参数严格对应创建实例传入数组中的规定的参数，执行时多余的参数为 undefined</span>
        args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将每个事件处理函数执行并调用返回 Promise 实例的 then 方法</span>
        <span class="token comment">// 让下一个事件处理函数在 then 方法成功的回调中执行</span>
        let <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">..</span><span class="token punctuation">.</span>others<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span>
        <span class="token keyword">return</span> others<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>上面代码中的 “串行” 是使用 <code>reduce</code> 归并来实现的，首先将存储所有事件处理函数的数组 <code>tasks</code> 解构成两部分，第一个事件处理函数和存储其他事件处理函数的数组 <code>others</code>，对 <code>others</code> 进行归并，将第一个事件处理函数执行后返回的 Promise 实例作为归并的初始值，这样在归并的过程中上一个值始终是上一个事件处理函数返回的 Promise 实例，可以直接调用 <code>then</code> 方法，并在 <code>then</code> 的回调中执行下一个事件处理函数，直到归并完成，将 <code>reduce</code> 最后返回的 Promise 实例作为 <code>promise</code> 方法的返回值，则实现 <code>promise</code> 方法执行后继续调用 <code>then</code> 来实现后续逻辑。</p> <h2 id="对其他异步钩子补充"><a href="#对其他异步钩子补充" class="header-anchor">#</a> 对其他异步钩子补充</h2> <p>在上面 <code>Async</code> 异步类型的 “钩子中”，我们只着重介绍了 “串行” 和 “并行”（<code>AsyncParallelHook</code> 和 <code>AsyncSeriesHook</code>）以及回调和 Promise 的两种注册和触发事件的方式，还有一些其他的具有一定特点的异步 “钩子” 我们并没有进行分析，因为他们的机制与同步对应的 “钩子” 非常的相似。</p> <p><code>AsyncParallelBailHook</code> 和 <code>AsyncSeriesBailHook</code> 分别为异步 “并行” 和 “串行” 执行的 “钩子”，返回值不为 <code>undefined</code>，即有返回值，则立即停止向下执行其他事件处理函数，实现逻辑可结合 <code>AsyncParallelHook</code> 、<code>AsyncSeriesHook</code> 和 <code>SyncBailHook</code>。</p> <p><code>AsyncSeriesWaterfallHook</code> 为异步 “串行” 执行的 “钩子”，上一个事件处理函数的返回值作为参数传递给下一个事件处理函数，实现逻辑可结合 <code>AsyncSeriesHook</code> 和 <code>SyncWaterfallHook</code>。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>在 <code>tapable</code> 源码中，注册事件的方法 <code>tab</code>、<code>tapSync</code>、<code>tapPromise</code> 和触发事件的方法 <code>call</code>、<code>callAsync</code>、<code>promise</code> 都是通过 <code>compile</code> 方法快速编译出来的，我们本文中这些方法的实现只是遵照了 <code>tapable</code> 库这些 “钩子” 的事件处理机制进行了模拟，以方便我们了解 <code>tapable</code>，为学习 Webpack 原理做了一个铺垫，在 Webpack 中，这些 “钩子” 的真正作用就是将通过配置文件读取的插件与插件、加载器与加载器之间进行连接，“并行” 或 “串行” 执行，相信在我们对 <code>tapable</code> 中这些 “钩子” 的事件机制有所了解之后，再重新学习 Webpack 的源码应该会有所头绪</p> <h3 id="_3-synchook"><a href="#_3-synchook" class="header-anchor">#</a> 3.syncHook</h3> <p><img src="/fish-vuePress/assets/img/image-20201202104612182.89fbc725.png" alt="image-20201202104612182"></p> <p>new SyncHook(['name']) //这里面的参数 决定了能接收几位参数</p> <p><img src="/fish-vuePress/assets/img/image-20201202105036107.a7ac52e9.png" alt="image-20201202105036107"></p> <h3 id="_4-syncbailhook"><a href="#_4-syncbailhook" class="header-anchor">#</a> 4.SyncBailHook</h3> <p><img src="/fish-vuePress/assets/img/image-20201202105157802.2b2dd2e6.png" alt="image-20201202105157802"></p> <p>这样更严谨 只能返回undefined 才会停止</p> <p><img src="/fish-vuePress/assets/img/image-20201202110414955.ce9091a6.png" alt="image-20201202110414955"></p> <h3 id="_5-syncwaterfallhook"><a href="#_5-syncwaterfallhook" class="header-anchor">#</a> 5.SyncWaterfallHook</h3> <p><img src="/fish-vuePress/assets/img/image-20201202110510751.95b27e7d.png" alt="image-20201202110510751"></p> <p><img src="/fish-vuePress/assets/img/image-20201202114107729.c28768ee.png" alt="image-20201202114107729"></p> <p><img src="/fish-vuePress/assets/img/image-20201202110611487.6c5f175a.png" alt="image-20201202110611487"></p> <p>结果</p> <p>1 zhufeng 10</p> <p>2 result1 10</p> <p>3 result2 10</p> <p>​</p> <p>如果第二个没有返回值 第三个的第一个参数会取上一个的返回值</p> <h3 id="_6-syncloophook"><a href="#_6-syncloophook" class="header-anchor">#</a> 6.SyncLoopHook</h3> <p>不停的执行回调函数 直到函数的返回结果是undefined</p> <p>注意 如果遇到不是undefined 函数是要重头执行</p> <p><img src="/fish-vuePress/assets/img/image-20201202114301794.2690cc69.png" alt="image-20201202114301794"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//不停的执行函数 直到函数结果返回undefined</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>counter1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>counter2 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>counter3 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//只要不返回undefined 又重头循环</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zhufeng'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1 zhufeng 10</span>
<span class="token comment">// 2 zhufeng 10</span>
<span class="token comment">// 1 zhufeng 10</span>
<span class="token comment">// 2 zhufeng 10</span>
<span class="token comment">// 3 zhufeng 10</span>
<span class="token comment">// 1 zhufeng 10</span>
<span class="token comment">// 2 zhufeng 10</span>
<span class="token comment">// 1 zhufeng 10</span>
<span class="token comment">// 2 zhufeng 10</span>
<span class="token comment">// 3 zhufeng 10</span>
<span class="token comment">// 1 zhufeng 10</span>
<span class="token comment">// 2 zhufeng 10</span>
</code></pre></div><h3 id="_7-asyncparallk"><a href="#_7-asyncparallk" class="header-anchor">#</a> 7.AsyncParallk</h3> <div class="language- extra-class"><pre class="language-text"><code>//异步的钩子（串行）并行需要等待所有并发的异步事件执行后再执行回调方法
//同时发送多个请求
//注册方法 tapAsync 异步执行  tap同步执行
</code></pre></div><p><img src="/fish-vuePress/assets/img/image-20201202224312734.7181bfed.png" alt="image-20201202224312734"></p> <h3 id=""><a href="#" class="header-anchor">#</a> <img src="/fish-vuePress/assets/img/image-20201202203316845.a9476ef2.png" alt="image-20201202203316845"></h3> <p><img src="/fish-vuePress/assets/img/image-20201202223429845.6d9a48f8.png" alt="image-20201202223429845"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token punctuation">{</span> <span class="token comment">// 异步并行的钩子</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tasks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">task</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'jw'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'err'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 1 jw</span>
<span class="token comment">// 2 jw</span>
<span class="token comment">// undefined err</span>
<span class="token comment">// cost: 2022.995ms</span>
<span class="token comment">// 3 jw</span>

</code></pre></div><h2 id="_12-intercept"><a href="#_12-intercept" class="header-anchor">#</a> 12.intercept</h2> <p><img src="/fish-vuePress/assets/img/image-20201202231653040.08d3c0d2.png" alt="image-20201202231653040"></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    SyncHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token string">'arg3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 注册拦截器
 */</span>
hook<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">//每次在call之前的钩子</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token string">'argument'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token string">'argument--register({type, fn, name}) {\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> name<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 注册监听事件
 */</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 事件触发
 */</span>

<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zhufeng'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//</span>
<span class="token punctuation">[</span>Arguments<span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">'0'</span><span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'sync'</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> argument<span class="token operator">--</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">[</span>Arguments<span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">'0'</span><span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'sync'</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> argument<span class="token operator">--</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> name<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

zhufeng <span class="token keyword">undefined</span> <span class="token keyword">undefined</span>
<span class="token punctuation">[</span>Arguments<span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">'0'</span><span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'sync'</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> argument
<span class="token number">1</span> zhufeng
<span class="token punctuation">[</span>Arguments<span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">'0'</span><span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'sync'</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> argument
<span class="token number">2</span> zhufeng

</code></pre></div><h2 id="_13-context"><a href="#_13-context" class="header-anchor">#</a> 13.context</h2> <p><img src="/fish-vuePress/assets/img/image-20201202233836989.5490394d.png" alt="image-20201202233836989"></p> <p>Loop 函数给context加个任意的对象属性 在注册监听函数的回调中都能拿到</p> <h3 id="_14-代码块"><a href="#_14-代码块" class="header-anchor">#</a> 14.代码块</h3> <p>![image-20201203235344125](/Users/zouyu/Library/Application Support/typora-user-images/image-20201203235344125.png)</p> <h2 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h2> <p><img src="/fish-vuePress/assets/img/image-20201204222037067.553442d0.png" alt="image-20201204222037067"></p> <p><img src="/Users/zouyu/Desktop/image-20201204221557067.png" alt="image-20201204221557067"></p> <p><img src="/fish-vuePress/assets/img/image-20201204221913835.b235f942.png" alt="image-20201204221913835"></p> <p><img src="/fish-vuePress/assets/img/image-20201204221938281.45524cae.png" alt="image-20201204221938281"></p> <h2 id="loader的整体流程"><a href="#loader的整体流程" class="header-anchor">#</a> loader的整体流程</h2> <p><img src="/fish-vuePress/assets/img/image-20201204223231352.75031a8e.png" alt="image-20201204223231352"></p> <p><img src="/fish-vuePress/assets/img/image-20201204224052828.07f29ce1.png" alt="image-20201204224052828"></p> <h3 id="_1-loader配置"><a href="#_1-loader配置" class="header-anchor">#</a> 1.loader配置</h3> <p><img src="/fish-vuePress/assets/img/image-20201204224438303.2351821a.png" alt="image-20201204224438303"></p> <p><img src="/fish-vuePress/assets/img/image-20201204225502993.ed375897.png" alt="image-20201204225502993"></p> <p><img src="/fish-vuePress/assets/img/image-20201204224511120.b4efdb08.png" alt="image-20201204224511120"></p> <p>![image-20201204225258519](/Users/zouyu/Library/Application Support/typora-user-images/image-20201204225258519.png)</p> <h3 id="_3-loader用法"><a href="#_3-loader用法" class="header-anchor">#</a> 3.loader用法</h3> <p><img src="/fish-vuePress/assets/img/image-20201204225612477.a59bd777.png" alt="image-20201204225612477"></p> <p><img src="/fish-vuePress/assets/img/image-20201204225757119.e2cb14c3.png" alt="image-20201204225757119"></p> <p>实现异步的写法</p> <p><img src="/fish-vuePress/assets/img/image-20201204225834994.6add392e.png" alt="image-20201204225834994"></p> <h3 id="_4-用法准则"><a href="#_4-用法准则" class="header-anchor">#</a> 4.用法准则</h3> <p><img src="/fish-vuePress/assets/img/image-20201204225934870.4e588fe7.png" alt="image-20201204225934870"></p> <p>![image-20201204231601906](/Users/zouyu/Library/Application Support/typora-user-images/image-20201204231601906.png)</p> <h3 id="_5-loader类型"><a href="#_5-loader类型" class="header-anchor">#</a> 5.loader类型</h3> <p><img src="/fish-vuePress/assets/img/image-20201207181835859.783bb785.png" alt="image-20201207181835859"></p> <p>noAutoLoader 不要普通loader 上面写错了</p> <p>Require('-!css-loader!./style.css');</p> <p>只执行后面的loader</p> <h3 id="_6-loader如何执行的"><a href="#_6-loader如何执行的" class="header-anchor">#</a> 6. loader如何执行的</h3> <p><img src="/fish-vuePress/assets/img/image-20201208185449187.73e146ec.png" alt="image-20201208185449187"></p> <p><img src="/fish-vuePress/assets/img/image-20201208180604020.13ce4b7f.png" alt="image-20201208180604020"></p> <p>enforce: post/pre/normal</p> <h3 id="_7-loader-api"><a href="#_7-loader-api" class="header-anchor">#</a> 7.loader api</h3> <h4 id="_7-1-this-cacheabe"><a href="#_7-1-this-cacheabe" class="header-anchor">#</a> 7-1.this.cacheabe</h4> <h4 id="_7-2-thia-async"><a href="#_7-2-thia-async" class="header-anchor">#</a> 7-2.thia.async</h4> <h4 id="_7-3-thia-callback"><a href="#_7-3-thia-callback" class="header-anchor">#</a> 7-3.thia.callback</h4> <h4 id="_7-4-loader-raw"><a href="#_7-4-loader-raw" class="header-anchor">#</a> 7-4.loader.raw</h4> <p><img src="/fish-vuePress/assets/img/image-20201204231718140.4a4123db.png" alt="image-20201204231718140"></p> <p><img src="/fish-vuePress/assets/img/image-20201204231839691.3e80e299.png" alt="image-20201204231839691"></p> <p><img src="/fish-vuePress/assets/img/image-20201204232011223.42fe474e.png" alt="image-20201204232011223"></p> <p>![image-20201204232044210](/Users/zouyu/Library/Application Support/typora-user-images/image-20201204232044210.png)</p> <p><img src="/fish-vuePress/assets/img/image-20201204232118408.4db4c8da.png" alt="image-20201204232118408"></p> <img src="/fish-vuePress/assets/img/image-20201204232136808.5a3142c6.png" alt="image-20201204232136808" style="zoom:50%;"> <h3 id="_8-loader-其他api"><a href="#_8-loader-其他api" class="header-anchor">#</a> 8.loader-其他api</h3> <p><img src="/fish-vuePress/assets/img/image-20201204232233081.fd46f5e3.png" alt="image-20201204232157118"></p> <p><img src="/fish-vuePress/assets/img/image-20201204232330588.b6d0a696.png" alt="image-20201204232330588"></p> <h2 id="_9-raw-loader"><a href="#_9-raw-loader" class="header-anchor">#</a> 9.raw-loader</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    $<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!./meta.html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
        <span class="token comment">/*!!忽略其他loader 如果不忽略会被ss-loader解析*/</span>
        $<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'!!raw-loader!./index.css'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>    <span class="token comment">//要放到head里面--&gt;</span>
    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
        $<span class="token punctuation">{</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!../node_modules/lib-flexible/flexible.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">}</span>
        <span class="token comment">// new htmlWebpackPlugin 可以识别 获取的代码给babel-loader raw-loader!babel-loader</span>
        <span class="token comment">// 再给raw-loader (简单获取啥就显示到这个地方就行了)</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
</code></pre></div><h2 id="pitch"><a href="#pitch" class="header-anchor">#</a> pitch</h2> <p><img src="/fish-vuePress/assets/img/image-20201205162739878.9f3fe7de.png" alt="image-20201205162739878"></p> <p><img src="/fish-vuePress/assets/img/image-20201207180340703.39105cae.png" alt="image-20201207180340703"></p> <h2 id="run-loader源码"><a href="#run-loader源码" class="header-anchor">#</a> Run-loader源码</h2> <div class="language-js extra-class"><pre class="language-js"><code>
loader1<span class="token punctuation">.</span>js
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader1'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> source <span class="token operator">+</span> <span class="token string">'//loader1'</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>picth<span class="token operator">=</span><span class="token string">'picthzy'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pitch1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
loader2<span class="token punctuation">.</span>js
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source <span class="token operator">+</span> <span class="token string">'//loader2'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pitch2'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'let name = &quot;loader3&quot;'</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
loader3<span class="token punctuation">.</span>js
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source <span class="token operator">+</span> <span class="token string">'//loader3'</span>
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remindingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pitch3'</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//默认情况下 loader得到的是字符串</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
执行结果
pitch1
pitch2
loader1 <span class="token punctuation">{</span> picth<span class="token operator">:</span> <span class="token string">'picthzy'</span> <span class="token punctuation">}</span>

</code></pre></div><div class="language-JS extra-class"><pre class="language-js"><code>run<span class="token operator">-</span>loader loader执行顺序源码
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createLoaderObject</span><span class="token punctuation">(</span><span class="token parameter">loaderPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//data是用来在pitch</span>
    obj<span class="token punctuation">.</span>request <span class="token operator">=</span> loaderPath<span class="token punctuation">;</span><span class="token comment">//loader这个文件的绝对路径</span>
    obj<span class="token punctuation">.</span>normal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//正常的loader函数</span>
    obj<span class="token punctuation">.</span>pitch <span class="token operator">=</span> obj<span class="token punctuation">.</span>normal<span class="token punctuation">.</span>pitch<span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">loaderContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//loader1!loader2!loader3!hello.js 所有</span>
            <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span> <span class="token operator">=&gt;</span> loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token string">'remindingRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//loader3!hello.js 不包括自己+后面</span>
            <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span> <span class="token operator">=&gt;</span> loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token string">'currentRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//loader2!loader3!hello.js 包括自己+后面</span>
            <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span> <span class="token operator">=&gt;</span> loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token string">'previousRequest'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//loader1 不包括自己的前面</span>
            <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">loader</span> <span class="token operator">=&gt;</span> loader<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//loader1 不包括自己的前面</span>
            <span class="token keyword">return</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> isSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> finnallyCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> loaderContext <span class="token operator">=</span> options<span class="token punctuation">.</span>context <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//loader的上下文环境</span>
    loaderContext<span class="token punctuation">.</span>resource <span class="token operator">=</span> options<span class="token punctuation">.</span>resource<span class="token punctuation">;</span>
    loaderContext<span class="token punctuation">.</span>loaders <span class="token operator">=</span> options<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createLoaderObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//loaderIndex正在执行的loader的索引</span>
    loaderContext<span class="token punctuation">.</span>readResource <span class="token operator">=</span> options<span class="token punctuation">.</span>readResource<span class="token punctuation">;</span>
    <span class="token function">defineProperty</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">asyncCallback</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> result<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    loaderContext<span class="token punctuation">.</span><span class="token function-variable function">async</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isSync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//改成异步</span>
        <span class="token keyword">return</span> asyncCallback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span> finnallyCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">&gt;=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">processRescource</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> currentLoaderObject <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> pitchFn <span class="token operator">=</span> currentLoaderObject<span class="token punctuation">.</span>pitch<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pitchFn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token function">pitchFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token punctuation">[</span>
            loaderContext<span class="token punctuation">.</span>remindingRequest<span class="token punctuation">,</span>
            loaderContext<span class="token punctuation">.</span>previousRequest<span class="token punctuation">,</span>
            loaderContext<span class="token punctuation">.</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//有返回值 不再向后面走了</span>
            loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> args<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">iteratePitchingLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">processRescource</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span>finnallyCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span><span class="token function">readResource</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>normal<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
    <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> result<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span> args<span class="token punctuation">,</span> finnallyCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loaderContext<span class="token punctuation">.</span>loaderIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">finnallyCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> currentLoaderObject <span class="token operator">=</span> loaderContext<span class="token punctuation">.</span>loaders<span class="token punctuation">[</span>loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> normalFn <span class="token operator">=</span> currentLoaderObject<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>
     args <span class="token operator">=</span> <span class="token function">normalFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> <span class="token punctuation">[</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>isSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         loaderContext<span class="token punctuation">.</span>loaderIndex<span class="token operator">--</span><span class="token punctuation">;</span>
         <span class="token function">iterateNormalLoaders</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">,</span> args<span class="token punctuation">,</span> finnallyCallback<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">runLoaders</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    resource<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'hello.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//要加载的资源</span>
    <span class="token comment">// String: Absolute path to the resource (optionally including query string)</span>

    loaders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//我们要用这三个loader去转换hello.js</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loaders'</span><span class="token punctuation">,</span> <span class="token string">'loader1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loaders'</span><span class="token punctuation">,</span> <span class="token string">'loader2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'loaders'</span><span class="token punctuation">,</span> <span class="token string">'loader3'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// String[]: Absolute paths to the loaders (optionally including query string)</span>
    <span class="token comment">// {loader, options}[]: Absolute paths to the loaders with options object</span>

    <span class="token comment">// context: { minimize: true },</span>
    context<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Additional loader context which is used as base context</span>

    readResource<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    <span class="token comment">// A function to read the resource</span>
    <span class="token comment">// Must have signature function(path, function(err, buffer))</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// err: Error?</span>

    <span class="token comment">// result.result: Buffer | String</span>
    <span class="token comment">// The result</span>

    <span class="token comment">// result.resourceBuffer: Buffer</span>
    <span class="token comment">// The raw resource as Buffer (useful for SourceMaps)</span>

    <span class="token comment">// result.cacheable: Bool</span>
    <span class="token comment">// Is the result cacheable or do it require reexecution?</span>

    <span class="token comment">// result.fileDependencies: String[]</span>
    <span class="token comment">// An array of paths (files) on which the result depends on</span>

    <span class="token comment">// result.contextDependencies: String[]</span>
    <span class="token comment">// An array of paths (directories) on which the result depends on</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="自模拟实现的loader"><a href="#自模拟实现的loader" class="header-anchor">#</a> 自模拟实现的loader</h2> <p><img src="/fish-vuePress/assets/img/image-20201204232436434.0a156ff8.png" alt="image-20201204232436434"></p> <h3 id="_1-babel-loader"><a href="#_1-babel-loader" class="header-anchor">#</a> 1.babel-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code>cnpm i @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env @babel<span class="token operator">/</span>core <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><p><img src="/fish-vuePress/assets/img/image-20201205140619654.d10d8f5e.png" alt="image-20201205140619654"></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token comment">// console.log(Object.keys(this))</span>
      <span class="token comment">//拿到{ presets: [ '@babel/preset-env' ] }</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span> <span class="token comment">// 绝对路径 E:\zouyu\study\webpack-dev\webpack-origin\src\index.js</span>

    <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过babel.transform将代码直接转化为函数字符串放到html模版中</span>
    babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>options<span class="token punctuation">,</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//文件名 处理文件的绝对路径</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//异步</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
  <span class="token comment">//同步</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">inputSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>options<span class="token punctuation">,</span>
        sourceMaps<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 生产sourceMaps</span>
        filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span>map<span class="token punctuation">,</span>ast<span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformSync</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//可以把sourcemap ast 都传给webpack 这样webapck</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> map<span class="token punctuation">,</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-banner-loader"><a href="#_2-banner-loader" class="header-anchor">#</a> 2.banner-loader</h3> <p><img src="/fish-vuePress/assets/img/image-20201205142834109.df447349.png" alt="image-20201205142834109"></p> <h3 id="_3-style-loader"><a href="#_3-style-loader" class="header-anchor">#</a> 3.style-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//require  返回的就是Css-loader处理好的结果</span>
<span class="token comment">// !!css-loader!less-loader!index.less</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//style-loader导出一个脚本</span>
    <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    let style = document.createElement('style');
    style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
    document.head.appendChild(style);
    </span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> style<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//在style-loader  css-loader less-loader</span>
<span class="token comment">//style-loader!css-loader!./style.css</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">remainingRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//剩余的请求</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>remainingRequest<span class="token punctuation">,</span> <span class="token string">'remainingRequest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    let style = document.createElement('style');
    style.innerHTML = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
        <span class="token string">'!!'</span> <span class="token operator">+</span> remainingRequest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    document.head.appendChild(style);
    </span><span class="token template-punctuation string">`</span></span>
    <span class="token comment">//如果不加！！会出现死循环</span>
    <span class="token keyword">return</span> style<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//pitch 如果有两个最左侧的loader要联合使用</span>
<span class="token comment">// JSON.stringify(source) 转换成一行  会把换行符转换成\r\n</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

</code></pre></div><h3 id="_4-css-loader"><a href="#_4-css-loader" class="header-anchor">#</a> 4.Css-loader</h3> <p>处理css中@import 和url这样的外部资源</p> <p>图片资源要拷贝到打包文件目录 项目引用的是打包后的文件</p> <p>Postcss</p> <p>LoadUtils.stringfyReauest(this,path) 会把绝对路径转换成适合loader的相对路径</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 主要实现处理@import 和 url() 语法,基于postcss
 */</span>
    <span class="token comment">//通过js插件处理样式</span>
<span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// css选择器的词法分析器,用于解析和序列化css选择器</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;css-selector-tokenizer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'css-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        importItems<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        urlItems<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>importItems<span class="token punctuation">,</span> urlItems<span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">let</span> importJs <span class="token operator">=</span> importItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">itemUrl</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> itemUrl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'itemurl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">&quot;require(&quot;</span> <span class="token operator">+</span> loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> itemUrl<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// require(url)返回一个打包后的绝对路径</span>
        <span class="token keyword">let</span> cssstring <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_CSS_URL_(\d+?)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> g1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// &quot;background-image: url('&quot; + require('&quot; + url + &quot;')&quot;;</span>
            <span class="token keyword">return</span> <span class="token string">'&quot;+ require(&quot;'</span> <span class="token operator">+</span> urlItems<span class="token punctuation">[</span><span class="token operator">+</span>g1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'&quot;).default + &quot;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cssstring <span class="token operator">=</span> cssstring<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@import\s+?.+?;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importJs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'${importJs}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cssstring<span class="token punctuation">,</span><span class="token string">'cssstring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importJs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssstring<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 自定义的js插件</span>
<span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>urlItems<span class="token punctuation">,</span> importItems<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历@import规则</span>
        css<span class="token punctuation">.</span><span class="token function">walkAtRules</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^import$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'valeus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> url <span class="token operator">=</span> values<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            importItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>importItems<span class="token punctuation">,</span> <span class="token string">'importItems'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历每一条样式</span>
        css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 解析样式属性的值</span>
            <span class="token keyword">const</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'url'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
                        item<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">&quot;_CSS_URL_&quot;</span> <span class="token operator">+</span> urlItems<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                        urlItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// 将解析后值返回序列化</span>
            decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">,</span><span class="token string">'decl.value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

</code></pre></div><h3 id="_5-file-loader"><a href="#_5-file-loader" class="header-anchor">#</a> 5.file-loader</h3> <p><img src="/fish-vuePress/assets/img/image-20201209100558811.5f210aa1.png" alt="image-20201209100558811"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 读取源文件内容；重命名；并写入到新的目录下
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> interpolateName<span class="token punctuation">,</span> getOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>filename<span class="token operator">=</span><span class="token string">'[name].[hash].[ext]'</span><span class="token punctuation">}</span><span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> outFilename <span class="token operator">=</span> <span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>outFilename<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//往输出目录下写文件</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>outFilename<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// 内容二进制形式</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

</code></pre></div><h3 id="_6-url-loader"><a href="#_6-url-loader" class="header-anchor">#</a> 6.url-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 当小于limit时，使用base64;
 如果文件小于limit不再拷贝 而是返回base64
 * 当大于limit时，根据file-loader处理
 */</span>
<span class="token comment">/**
 * 读取源文件内容；重命名；并写入到新的目录下
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> interpolateName<span class="token punctuation">,</span> getOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fileloader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>filename<span class="token operator">=</span><span class="token string">'[name].[hash].[ext]'</span><span class="token punctuation">,</span> limit<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> constType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回此图片的内容类型</span>
    <span class="token keyword">let</span> base64 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>constType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">//一定要转换成字符串类型</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">fileloader</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 内容二进制形式</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-sprite-loader"><a href="#_7-sprite-loader" class="header-anchor">#</a> 7.sprite-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>css 定义需要替换成精灵图的图片
<span class="token punctuation">.</span>two <span class="token punctuation">{</span>
    background<span class="token operator">-</span>image<span class="token operator">:</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'./b.png?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    height<span class="token operator">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span>three <span class="token punctuation">{</span>
    background<span class="token operator">-</span>image<span class="token operator">:</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'./c.png?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    height<span class="token operator">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>one <span class="token punctuation">{</span>
    background<span class="token operator">-</span>image<span class="token operator">:</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'./a.png?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    height<span class="token operator">:</span> <span class="token number">200</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>sprite<span class="token operator">-</span>loader<span class="token punctuation">.</span>js
<span class="token comment">/**
 * 找到需要生成雪碧图的图片
 *
 */</span>
<span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> spritesmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;css-selector-tokenizer&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">//this.context代表加载资源的上下文目录</span>
   <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//代表css文件本身</span>
         css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// console.log(decl);</span>
             <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// console.log(JSON.stringify(values.nodes));</span>
             values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                 <span class="token comment">// console.log(JSON.stringify(value.nodes));</span>
                 value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'url'</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'?sprite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                         <span class="token comment">//找到这个图片的绝对路径</span>
                         <span class="token keyword">let</span> url <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>context<span class="token punctuation">,</span> item<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token comment">// url = url.replace(/(\?sprite)/, '');</span>
                         item<span class="token punctuation">.</span>url <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">;</span><span class="token comment">//改变css</span>

                         <span class="token comment">// console.log(url, item.url, 'url---');</span>
                         <span class="token comment">//按理说我要在当前规则下面添加一条规则background.position</span>
                         postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                             url<span class="token punctuation">,</span><span class="token comment">//原始图片的绝对路径 未来要用来合并雪碧图</span>
                             rule<span class="token operator">:</span> decl<span class="token punctuation">.</span>parent <span class="token comment">//当前规则</span>
                         <span class="token punctuation">}</span><span class="token punctuation">)</span>
                     <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span><span class="token punctuation">)</span>

             <span class="token punctuation">}</span><span class="token punctuation">)</span>
             decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
           postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>rule<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
               console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               rule<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>postcss<span class="token punctuation">.</span><span class="token function">decl</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                   prop<span class="token operator">:</span><span class="token string">'background-position'</span><span class="token punctuation">,</span>
                   value<span class="token operator">:</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_BACKGROUNG_POSITON_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token template-punctuation string">`</span></span> <span class="token comment">//弄个占位符 到时候替换一下子</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
    <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span>spriteFilename<span class="token operator">:</span><span class="token string">'sprite.jpg'</span><span class="token punctuation">,</span>rules<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">from</span><span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cssresult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(result);</span>
        <span class="token keyword">let</span> cssStr <span class="token operator">=</span> cssresult<span class="token punctuation">.</span>css<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> sprites <span class="token operator">=</span> postcssOptions<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>item<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">,</span>sprites<span class="token punctuation">,</span><span class="token string">'sprites'</span><span class="token punctuation">)</span>
        spritesmith<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>src<span class="token operator">:</span>sprites<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// console.log(err,result);</span>
            <span class="token keyword">let</span> coordinates <span class="token operator">=</span> result<span class="token punctuation">.</span>coordinates<span class="token punctuation">;</span>

            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span>
                cssStr <span class="token operator">=</span> cssStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_BACKGROUNG_POSITON_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px -</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>coordinates<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            that<span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">.</span>spriteFilename<span class="token punctuation">,</span> result<span class="token punctuation">.</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//JSON.stringify 可以处理某些换行符  直接用双引号会出现断行</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

</code></pre></div><h3 id="_8-px2rem-loader"><a href="#_8-px2rem-loader" class="header-anchor">#</a> 8.px2rem-loader</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 找到需要生成雪碧图的图片
 *
 */</span>
<span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> spritesmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'spritesmith'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;css-selector-tokenizer&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>remUnit <span class="token operator">=</span> <span class="token number">75</span><span class="token punctuation">,</span>remPrecision<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">}</span> <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">//this.context代表加载资源的上下文目录</span>
    <span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter">postcssOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//代表css文件本身</span>
            css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// console.log(decl);</span>
                <span class="token keyword">let</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// console.log(JSON.stringify(values.nodes));</span>
                values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// console.log(JSON.stringify(value.nodes));</span>
                    value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> px <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>px <span class="token operator">/</span> remUnit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>remPrecision<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            item<span class="token punctuation">.</span>name <span class="token operator">=</span> rem<span class="token operator">+</span><span class="token string">'rem'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>postcssOptions<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">from</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cssresult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> cssStr <span class="token operator">=</span> cssresult<span class="token punctuation">.</span>css<span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssStr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//JSON.stringify 可以处理某些换行符  直接用双引号会出现断行</span>

<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span>

</code></pre></div><p>让webpack帮助我们实现雪碧图</p> <h2 id="loader-utils看官方文档"><a href="#loader-utils看官方文档" class="header-anchor">#</a> <font face="微软雅黑" size="6" color="#FF0000">Loader--utils</font>看官方文档</h2> <p>地址</p> <p>https://blog.csdn.net/weixin_33795806/article/details/91379506</p> <ul><li><strong>parseQuery(解析被调用loader的配置选项)</strong></li></ul> <p>将传递的字符串（例如loaderContext.resourceQuery）解析为查询字符串，并返回一个对象。</p> <ul><li><p><strong>parseString(是将字符串转化为json对象)</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> params <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">parseQuery</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceQuery<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// resource: `file?param1=foo`</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>param1 <span class="token operator">===</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>getOptions(检索被调用loader的配置选项)</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>检索加载程序调用选项的推荐方法：
1.如果this.query是字符串:尝试解析查询字符串并返回一个新对象
2.如果它不是有效的查询字符串则抛出
3.如果this.query是对象，它只是返回this.query
4.在任何其他情况下，它只是返回 null</p></li> <li><p><strong>stringifyRequest(将一个请求转化为非绝对路径的可被require或import的字符串；)</strong></p> <p>将请求转换为可在内部使用require()或import在避免绝对路径时使用的字符串。JSON.stringify(...)如果您在加载器中生成代码，请使用它。为什么这有必要？由于webpack在模块路径转换为模块ID之前计算哈希值，因此我们必须避免绝对路径以确保跨不同编译的一致哈希。</p> <blockquote><p>前置知识：</p></blockquote> <blockquote><ol><li>path.posix是跨平台兼容方案，path.win32则是兼容windows</li></ol></blockquote> <blockquote><ol><li>isAbsolute判断路径是否为绝对路径，值得注意的是在<strong>posix</strong>上 path.isAbsolute('/foo/bar'); // true path.isAbsolute('/baz/..'); // true path.isAbsolute('qux/'); // false path.isAbsolute('.'); // false 在<strong>win</strong>上path.isAbsolute('//server'); // true path.isAbsolute('\server'); // true path.isAbsolute('C:/foo/..'); // true path.isAbsolute('C:\foo..'); // true path.isAbsolute('bar\baz'); // false path.isAbsolute('bar/baz'); // false path.isAbsolute('.'); // false</li></ol></blockquote> <blockquote><ol><li>path.relative(from, to)方法根据当前工作目录返回 from 到 to 的相对路径。 如果 from 和 to 各自解析到相同的路径（分别调用 path.resolve() 之后），则返回零长度的字符串。如果将零长度的字符串传入 from 或 to，则使用当前工作目录代替该零长度的字符串。例如，在 POSIX 上：path.relative('/data/orandea/test/aaa', '/data/orandea/impl/bbb'); // 返回: '../../impl/bbb',在 Windows 上：path.relative('C:\orandea\test\aaa', 'C:\orandea\impl\bbb');// 返回: '....\impl\bbb'如果 from 或 to 不是字符串，则抛出 TypeError。</li></ol></blockquote></li> <li><p><strong>urlToRequest(将url转换成适合webpack环境的模块请求)</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">&quot;/path/to/module.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token string">&quot;./root&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">urlToRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;./root/path/to/module.js&quot;</span>

</code></pre></div></li> <li><p><strong>getHashDigest(通过限制字符长度获取文件部分哈希值)</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> digestString <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getHashDigest</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> hashType<span class="token punctuation">,</span> digestType<span class="token punctuation">,</span> maxLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li><ol><li>buffer：应该散列的内容</li></ol></li> <li><ol><li>hashType之一sha1，md5，sha256，sha512或任何其他的node.js支持的哈希类型</li></ol></li> <li><ol><li>digestType一hex，base26，base32，base36，base49，base52，base58，base62，base64</li></ol></li> <li><ol><li>maxLength 字符的最大长度</li></ol></li></ul></li> <li><p><strong>interpolateName(自定义资源名称、hash等)</strong></p> <p>前置知识 path.parse() 方法返回一个对象，其属性表示 path 的重要元素。 尾部的目录分隔符将被忽略，参阅 path.sep。返回对象包含以下属性<code>&lt;string&gt; root &lt;string&gt; base &lt;string&gt; name &lt;string&gt; ext &lt;string&gt;</code></p> <div class="language-js extra-class"><pre class="language-js"><code>
在posix上：
path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'/home/user/dir/file.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回:</span>
<span class="token comment">// { root: '/',</span>
<span class="token comment">//   dir: '/home/user/dir',</span>
<span class="token comment">//   base: 'file.txt',</span>
<span class="token comment">//   ext: '.txt',</span>
<span class="token comment">//   name: 'file' }</span>
┌─────────────────────┬────────────┐
│          dir        │    base    │
├──────┬              ├──────┬─────┤
│ root │              │ name │ ext │
<span class="token string">&quot;  /    home/user/dir / file  .txt &quot;</span>
└──────┴──────────────┴──────┴─────┘
（<span class="token string">&quot;&quot;</span> 行中的所有空格都应该被忽略，它们纯粹是为了格式化）
在window上：
path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'C:\\path\\dir\\file.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回:</span>
<span class="token comment">// { root: 'C:\\',</span>
<span class="token comment">//   dir: 'C:\\path\\dir',</span>
<span class="token comment">//   base: 'file.txt',</span>
<span class="token comment">//   ext: '.txt',</span>
<span class="token comment">//   name: 'file' }</span>
┌─────────────────────┬────────────┐
│          dir        │    base    │
├──────┬              ├──────┬─────┤
│ root │              │ name │ ext │
<span class="token string">&quot; C:\      path\dir   \ file  .txt &quot;</span>
└──────┴──────────────┴──────┴─────┘
（<span class="token string">&quot;&quot;</span> 行中的所有空格都应该被忽略，它们纯粹是为了格式化）

</code></pre></div></li> <li><p><strong>isUrlRequest(判断是否是路径)</strong></p></li> <li><p><strong>getCurrentRequest(获取当前请求)</strong></p></li> <li><p><strong>getRemainingRequest(获取请求)</strong></p></li></ul> <h2 id="plugin"><a href="#plugin" class="header-anchor">#</a> plugin</h2> <h3 id="_1-plugin"><a href="#_1-plugin" class="header-anchor">#</a> 1.plugin</h3> <p><img src="/fish-vuePress/assets/img/image-20201209225646775.6679804e.png" alt="image-20201209225646775"></p> <h3 id="_2-创建插件"><a href="#_2-创建插件" class="header-anchor">#</a> 2.创建插件</h3> <p><img src="/fish-vuePress/assets/img/image-20201210101128878.92695eb5.png" alt="image-20201210101128878"></p> <h3 id="_3-基本插件架构"><a href="#_3-基本插件架构" class="header-anchor">#</a> 3.基本插件架构</h3> <p><img src="/fish-vuePress/assets/img/image-20201210101327148.028a1ddc.png" alt="image-20201210101327148"></p> <h3 id="_4-预获取插件"><a href="#_4-预获取插件" class="header-anchor">#</a> 4.预获取插件</h3> <h3 id="npx-webpack-profile-json-stats-json"><a href="#npx-webpack-profile-json-stats-json" class="header-anchor">#</a> npx webpack --profile --json &gt; stats.json</h3> <div class="language-js extra-class"><pre class="language-js"><code>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//给分离的代码块起个名字</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/*webpackPrefetch:true*/</span><span class="token comment">/*webpackChunkName:'hello'*/</span><span class="token string">'./hello'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/*webpackChunkName:'world'*/</span><span class="token string">'./world'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
打包文件
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>插件js
<span class="token comment">/**
 * 1.获取compilation
 * 2.监听钩子
 * compilation.hooks.htmlWebpackPluginAlterAssetTags = new AsyncSeriesWaterfallHook([''])
 */</span>

<span class="token keyword">class</span> <span class="token class-name">PrefetchPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'PrefetchPlugin'</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----The compiler is starting a new compilation...-----------------------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// console.log(compilation.hooks.htmlWebpackPluginBeforeHtmlProcessing)</span>
            <span class="token comment">//生成标签的时候做一些事情</span>
            compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>htmlWebpackPluginAlterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'PrefetchPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">htmlData<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//如何拿到文件名</span>
                <span class="token keyword">let</span> chunkMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//所有代码块都在chunks上</span>
                <span class="token keyword">let</span> tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    chunkMap<span class="token punctuation">[</span>chunk<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token operator">=</span> chunk<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//循坏每个代码块</span>
                    <span class="token keyword">let</span> prefetchChunkIds <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">getChildIdsByOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prefetch<span class="token punctuation">;</span>
 
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prefetchChunkIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'===================================='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prefetchChunkIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prefetchChunkIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">prefetchChunkId</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> files <span class="token operator">=</span> chunkMap<span class="token punctuation">[</span>prefetchChunkId<span class="token punctuation">]</span><span class="token punctuation">.</span>files<span class="token punctuation">;</span>
                            files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                tags<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                    tagName<span class="token operator">:</span> <span class="token string">'link'</span><span class="token punctuation">,</span>
                                    closeTag<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                    attributes<span class="token operator">:</span> <span class="token punctuation">{</span>ref<span class="token operator">:</span> <span class="token string">'prefetch'</span><span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'script'</span><span class="token punctuation">,</span> href<span class="token operator">:</span> file<span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                htmlData<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// htmlData.head.push(</span>
                <span class="token comment">//     {</span>
                <span class="token comment">//         tagName: 'link',</span>
                <span class="token comment">//         closeTag: true,</span>
                <span class="token comment">//         attributes: {ref: 'prefetch', as: 'script', href: 'hello.bundle.js'}</span>
                <span class="token comment">//     }</span>
                <span class="token comment">// )</span>
                <span class="token comment">// htmlData.head.push({</span>
                <span class="token comment">//     tagName: 'link',</span>
                <span class="token comment">//     closeTag: true,</span>
                <span class="token comment">//     attributes: {ref: 'prefetch', as: 'script', href: 'world.bundle.js'}</span>
                <span class="token comment">// })</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PrefetchPlugin<span class="token punctuation">;</span>

</code></pre></div><p><img src="/fish-vuePress/assets/img/image-20201210113538324.c2baa1f7.png" alt="image-20201210113538324"></p> <p><img src="/fish-vuePress/assets/img/image-20201210160704836.4a642310.png" alt="image-20201210160704836"></p> <p><img src="/fish-vuePress/assets/img/image-20201210160733525.0cbd26d8.png" alt="image-20201210160733525"></p> <p><img src="/fish-vuePress/assets/img/image-20201210160848905.61496c54.png" alt="image-20201210160848905"></p> <p><img src="/fish-vuePress/assets/img/image-20201210162450026.5569d230.png" alt="image-20201210162450026"></p> <h3 id="_5-done-plugin"><a href="#_5-done-plugin" class="header-anchor">#</a> 5.done-plugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//插件就是一个类 有一个apply方法接受一个complier方法</span>
<span class="token comment">//我们会在compiler对象上钩子上挂载一个监听函数</span>
<span class="token comment">// 当compiler这个对象上的钩子函数触发的时候 会执行对应的监听函数</span>

<span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//同步插件</span>
        <span class="token comment">//打包完成告诉一下吗 hooks实例 挂载很多钩子函数</span>
        <span class="token comment">//每当编译完成之后都会call done这个事件</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DonePlugin'</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">'编译完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span>

</code></pre></div><h3 id="_6-optimizeplugin"><a href="#_6-optimizeplugin" class="header-anchor">#</a> 6.OptimizePlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//我们想知道如何获取到compilation对象</span>
<span class="token keyword">class</span> <span class="token class-name">OptimizePlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//每当compiler创建出来一个compilation对象 就会触发回调 参数就是compilation</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'OptimizePlugin'</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'OptimizePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack优化中----'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> OptimizePlugin<span class="token punctuation">;</span>

</code></pre></div><h3 id="_7-zipplugin"><a href="#_7-zipplugin" class="header-anchor">#</a> 7.ZipPlugin</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/**
 * 写一个插件的思路
 * 1.找到插件代码需要执行的钩子
 * 2.知道钩子函数的参数和数据结构，进行加工
 */</span>
<span class="token keyword">const</span> JsZip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jszip'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>RawSource<span class="token punctuation">}</span><span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-sources'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ZipPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当资源已经准备就绪 准备向输出的目录写入的时候会触发这个钩子</span>
        <span class="token comment">//写入文件之前触发</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'OptimizePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">,</span> <span class="token string">'compilation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">/**
            {
                'bundle.js': CachedSource {
                _source: ConcatSource { children: [Array] },
                _cachedSource: undefined,
                    _cachedSize: undefined,
                    _cachedMaps: {},
                node: [Function],
                    listMap: [Function]
            },
                'index.html': { source: [Function: source], size: [Function: size] }
            } compilation
            */</span>
           <span class="token keyword">var</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> filename <span class="token keyword">in</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">//把所有文件压成一个压缩包 将压缩包的二进制内容content</span>
           <span class="token keyword">return</span> zip<span class="token punctuation">.</span><span class="token function">generateAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span><span class="token string">'nodebuffer'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">content</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
               <span class="token comment">//向Assets属性上新挂载了一个值</span>
               <span class="token comment">//一种写法</span>
               <span class="token comment">/**
                *
                * @type {{size(): *, source(): *}}
                * compilation.assets[this.options.name] = {
                   source() {
                       return content;
                   },
                   size() {
                       return content.length;
                   }
               }
                */</span>
               <span class="token comment">//借助webpack源码</span>
               compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
               <span class="token comment">// cb(null, compilation);</span>
               <span class="token comment">// return Promise.resolve(compilation);//tappromise没有cb 这个还可以不用</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ZipPlugin<span class="token punctuation">;</span>


</code></pre></div><h3 id="_8-自动外链"><a href="#_8-自动外链" class="header-anchor">#</a> 8.自动外链</h3> <p><img src="/fish-vuePress/assets/img/image-20201210174845939.103f96a4.png" alt="image-20201210174845939"></p> <h3 id="_9-自动上传到cdn"><a href="#_9-自动上传到cdn" class="header-anchor">#</a> 9.自动上传到cdn</h3> <p><img src="/fish-vuePress/assets/img/image-20201210181157428.fc26bae0.png" alt="image-20201210181157428"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// UploadPlugin.js/</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//把外链的标签变成内链的</span>
<span class="token keyword">class</span> <span class="token class-name">UploadPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>
            bucket <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
            domain <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            accesskey <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
            secretKey <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">let</span> mac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>digest<span class="token punctuation">.</span>Mac</span><span class="token punctuation">(</span>accesskey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> putPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>rs<span class="token punctuation">.</span>putPolicy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scope<span class="token operator">:</span> bucket<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uploadToken <span class="token operator">=</span> putPolicy<span class="token punctuation">.</span><span class="token function">uploadToken</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>formUploader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>FormUploader</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>putExtra <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>PutExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'UploadPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> assets <span class="token operator">=</span>  compilation<span class="token punctuation">.</span>assets<span class="token punctuation">;</span>
            <span class="token keyword">let</span> promise <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>
    <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>formUploader<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploadToken<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putExtra<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> body<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reslove</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploadPlugin<span class="token punctuation">;</span>

</code></pre></div><h2 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h2> <p><img src="/fish-vuePress/assets/img/image-20201210215012214.eba04edc.png" alt="image-20201210215012214"></p> <p>![image-20201210215157289](/Users/zouyu/Library/Application Support/typora-user-images/image-20201210215157289.png)</p> <p><img src="/fish-vuePress/assets/img/image-20201210220425294.3cd0b872.png" alt="image-20201210220425294"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//源代码转换成语法树</span>
<span class="token keyword">let</span>  traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span><span class="token comment">//用来遍历语法树的节点并且对节点增删改</span>
<span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//判断某种节点是否指定类型 或者用来生成一个新节点</span>
<span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span><span class="token comment">//用来把语法树重新编程代码</span>
<span class="token comment">//源代码 -&gt; babylon转成语法树--&gt;traverse遍历节点---&gt;types生成新的节点替换老节点-&gt;generator重新生成代码</span>
</code></pre></div><p><img src="/fish-vuePress/assets/img/image-20201210221747289.fa4f1b4c.png" alt="image-20201210221747289"></p> <p><img src="/fish-vuePress/assets/img/image-20201210221612952.310a3ad0.png" alt="image-20201210221612952"></p> <p><img src="/fish-vuePress/assets/img/image-20201210221849496.e5f20390.png" alt="image-20201210221849496"></p> <p><img src="/fish-vuePress/assets/img/image-20201210222258415.27100ee6.png" alt="image-20201210222258415"></p> <p><img src="/fish-vuePress/assets/img/image-20201210222144162.8369cb1b.png" alt="image-20201210222144162"></p> <h2 id="懒加载"><a href="#懒加载" class="header-anchor">#</a> 懒加载</h2> <p><img src="/fish-vuePress/assets/img/image-20201210223935417.c486df49.png" alt="image-20201210223935417"></p> <p><img src="/fish-vuePress/assets/img/image-20201210223836173.8c63f5be.png" alt="image-20201210223836173"></p> <p>buildModule</p> <p><img src="/fish-vuePress/assets/img/image-20201210225136360.c510a3ef.png" alt="image-20201210225136360"></p> <p><img src="/fish-vuePress/assets/img/image-20201210225805779.1250e493.png" alt="image-20201210225805779"></p> <p><img src="/fish-vuePress/assets/img/image-20201210225221462.d28ce529.png" alt="image-20201210225221462"></p> <p><img src="/fish-vuePress/assets/img/image-20201210225341223.b33af9a7.png" alt="image-20201210225341223"></p> <p>emit</p> <p><img src="/fish-vuePress/assets/img/image-20201210225453150.017f90ab.png" alt="image-20201210225453150"></p> <p><img src="/fish-vuePress/assets/img/image-20201210225430426.4cd80b8b.png" alt="image-20201210225430426"></p> <p><img src="/fish-vuePress/assets/img/image-20201210230453741.acbec245.png" alt="image-20201210230453741"></p> <p><img src="/fish-vuePress/assets/img/image-20201210230141872.047f6dd1.png" alt="image-20201210230141872"></p> <p><img src="/fish-vuePress/assets/img/image-20201210230354178.fccaee88.png" alt="image-20201210230354178"></p> <h2 id="热更新"><a href="#热更新" class="header-anchor">#</a> 热更新</h2> <h3 id="_1-服务端"><a href="#_1-服务端" class="header-anchor">#</a> 1.服务端</h3> <p><img src="/fish-vuePress/assets/img/image-20201210234014584.f99d8c0c.png" alt="image-20201210234014584"></p> <p><img src="/fish-vuePress/assets/img/image-20201210234208140.aa72fc4a.png" alt="image-20201210234208140"></p> <p><img src="/fish-vuePress/assets/img/image-20201210234635326.50d34c4f.png" alt="image-20201210234635326"></p> <p><img src="/fish-vuePress/assets/img/image-20201210234453348.623294d6.png" alt="image-20201210234453348"></p> <p><img src="/fish-vuePress/assets/img/image-20201210234926661.9cf9f1ae.png" alt="image-20201210234926661"></p> <p><img src="/fish-vuePress/assets/img/image-20201210235003523.c3fa96e5.png" alt="image-20201210235003523"></p> <h3 id="_2-客户端"><a href="#_2-客户端" class="header-anchor">#</a> 2.客户端</h3> <p><img src="/fish-vuePress/assets/img/image-20201210235138561.421a4968.png" alt="image-20201210235138561"></p> <p><img src="/fish-vuePress/assets/img/image-20201210235337031.08aa88e0.png" alt="image-20201210235337031"></p> <h2 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h2> <p>[1,2,3].includes('')  promise 这是高级语法 需要配置 usage :好处是可以按需加载</p> <p><img src="/fish-vuePress/assets/img/image-20201211100720232.84d63961.png" alt="image-20201211100720232"></p> <h1 id="webpack的loader的原理和实现-博文推荐"><a href="#webpack的loader的原理和实现-博文推荐" class="header-anchor">#</a> <a href="https://www.cnblogs.com/lyraLee/p/12050811.html" target="_blank" rel="noopener noreferrer">webpack的loader的原理和实现-博文推荐<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h1> <p>想要实现一个loader，需要首先了解loader的基本原理和用法。</p> <h3 id="_1-使用"><a href="#_1-使用" class="header-anchor">#</a> 1. 使用</h3> <p>loader是处理模块的解析器。</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>  module: {
    rules: [
      {
        test: /\.css$/,
        use: [ // 多个loader，从右向左解析，即css-loader开始
          MiniCssExtractPlugin.loader,
          'css-loader'
        ]
      }
}
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h3 id="_2-自定义loader的查找规则"><a href="#_2-自定义loader的查找规则" class="header-anchor">#</a> 2.自定义loader的查找规则</h3> <p>很多时候，我们可以自己定义loader, 比如在根目录下新建一个loaders的文件夹，文件夹内实现各个loader的代码。但是webpack不识别这些loader，我们需要配置使webpack识别这些自定义的loader。</p> <p>有四种方式：</p> <p>\1. resolveLoader.moduels</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>  resolveLoader: {
    modules: ['node_modules', 'loaders'] // 先从node_modules中查找，没有从loaders文件夹中查找loader1.js
  },
  module: {
    rules: [
      {
        test: /\.js/,
        use: ['loader1']
      }
    ]
  }
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p>2.resolveLoader.alias</p> <div class="language- extra-class"><pre class="language-text"><code>  resolveLoader: {
    alias: {// 绝对路径
      loader1: path.resolve(__dirname, 'loaders', 'loader1.js')
    }
  },
</code></pre></div><p>3.loader的绝对路径</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>  module: {
    rules: [
      {
        test: /\.js/,
        use: [path.resolve(__dirname, 'loaders', 'loader1.js')]
      }
    ]
  }
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p>4.npm link(待解决)</p> <h3 id="_3-loader的标准"><a href="#_3-loader的标准" class="header-anchor">#</a> 3. loader的标准</h3> <p>\1. 一个loader只实现一个功能，复合设计的单一功能原则。</p> <p>\2. loader的处理顺序。</p> <p>当一个文件需要多个loader时，从最后的loader开始执行，其传入的参数是文件的原始内容。返回结果传入倒数第二个loader, 作为其入参，依次处理，直到第一个loader。</p> <p>\3. loaders 处理的最终结果(最后一个loader返回值)是一个字符串/Buffer。</p> <h3 id="_4-loader类型"><a href="#_4-loader类型" class="header-anchor">#</a> 4. loader类型</h3> <p>loader的加载顺序是按照pre-&gt;normal-&gt;inline-&gt;post的顺序执行</p> <h4 id="_1-pre-前置loader"><a href="#_1-pre-前置loader" class="header-anchor">#</a> 1.pre-前置loader</h4> <p>rule.enforce = pre;</p> <div class="language- extra-class"><pre class="language-text"><code>      { 
        test: /test\.js$/,
        loader: 'loader3',
        enforce: 'pre'
      },
</code></pre></div><h4 id="_2-normal-正常loader"><a href="#_2-normal-正常loader" class="header-anchor">#</a> 2.normal-正常loader</h4> <p>没有任何特征的loader都是普通loader</p> <h4 id="_3-inline-行内loader"><a href="#_3-inline-行内loader" class="header-anchor">#</a> 3.inline-行内loader</h4> <div class="language- extra-class"><pre class="language-text"><code>// 对test.js使用loader1和loader2
import 'loader1!loader2!./test.js'； // 按照从右到左，先执行loader2
</code></pre></div><p>行内loader的一个应用场景是，loader中pitch的参数remainingRequest。其通过loaderUtils.stringifyRequest(this, XXXX)后，变为</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;../loaders/css-loader.js!./style.css&quot;
</code></pre></div><p>对于正常的.css文件，会根据webpack中的规则，从右向左加载。但是对于上面的行内loader,有三个标志符号指定哪些loader。</p> <p>1）! 忽略普通loader</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>// 表示忽略webpack配置中的正常loader，然后按照loader类型的顺序加载
require(&quot;!&quot; + &quot;../loaders/css-loader.js!./style.css&quot;)
</code></pre></div><p>\2. -! 忽略普通和前置loader</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>// 表示忽略webpack配置中的正常和前置loader
require(&quot;-!&quot; + &quot;../loaders/css-loader.js!./style.css&quot;)
</code></pre></div><p>\3. !! 只使用行内loader 忽略普通，前置，后置loader；</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>// 表示只使用行内loader, 忽略webpack配置中的loader
require(&quot;!!&quot; + &quot;../loaders/css-loader.js!./style.css&quot;)
</code></pre></div><h4 id="_4-post-后置loader"><a href="#_4-post-后置loader" class="header-anchor">#</a> 4.post-后置loader</h4> <div class="language- extra-class"><pre class="language-text"><code>      { 
        test: /test\.js$/,
        loader: 'loader5',
        enforce: 'post'
      },
</code></pre></div><h3 id="_6-loaders的常见api"><a href="#_6-loaders的常见api" class="header-anchor">#</a> 6. loaders的常见API</h3> <h4 id="_1-this-callback"><a href="#_1-this-callback" class="header-anchor">#</a> 1. this.callback</h4> <p>当loader有单个返回值时可以直接使用return返回。当需要返回多个结果时，需要使用this.callback。</p> <p>其预期参数如下：</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>this.callback(
    err: Error | null,
    content: string | Buffer,
    sourceMap?:SourceMap, // 可选传参
    meta?:any //元数据，可以是任意值；当将AST作为参数传递时，可以提高编译速度
}
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p>⚠️： 使用该方法时，loader必须返回undefined。</p> <h4 id="_2-越过loader-pitching-loader"><a href="#_2-越过loader-pitching-loader" class="header-anchor">#</a> 2. 越过loader(Pitching loader)</h4> <p><strong>含义：</strong></p> <p>Pitching loader指的是loader上的pitch方法。</p> <p><strong>语法：</strong></p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value: 42}</span>
  <span class="token keyword">return</span> stringorBuffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 对于请求index.js的rule
 * use: ['loader1','loader2', 'loader3']
 *
 * @param {*} remainingRequest 
 * 剩余的请求。
 * 如果返回undefined，则按照remainingRequest的顺序访问下一个loader的pitch
 * 对于第一个被调用的pitch方法来说，其值为: loader2!loader3!index.js
 * 
 * @param {*} precedingRequest 
 * 前一个请求。
 * 1. 如果返回一个非undefined值，则直接进入precedingRequest所在的loader方法,
 * 并且将pitch的返回值作为该loader方法的参数。
 * 如果该loader不是FinalLoader,按照从右到左顺序依次执行
 * 2. 有一个特殊情况，如果第一个pitch方法返回一个非undefined值，
 * 它必须是string|Buffer,因为它将作为该FinalLoader的返回值
 * 
 * @param {*} data 
 * pitch中的数据。
 * 初始值是空对象{},可以给其赋值，然后通过loader方法中的this.date共享该数据
 */</span>
 module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remainingRequest<span class="token punctuation">,</span> precedingRequest<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
  <span class="token comment">// 此处可以返回数据；但是如果是第一个pitch，只能返回string|Buffer,它就是最终结果</span>
<span class="token punctuation">}</span>
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p><strong>作用：</strong></p> <p>正常的loader加载顺序是从右到左。但是在执行loader之前，会从左到右的调用loader上的pitch方法，可以根据该方法的返回值，决定后续的loader要跳过不执行。其方法中传入的data数据可以通过loader方法中的this.data进行共享。</p> <p><strong>应用场景：</strong></p> <p>1 ）最左侧的两个loader之间有关联关系；手动加载loader。</p> <p>如：style-loader和css-loader</p> <p>2 ) pitch阶段给data赋值，在执行阶段从this.data取值</p> <p>3）通过pitch可以跳过某些loader</p> <p><strong>执行顺序</strong>：</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code>use<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'a-loader'</span><span class="token punctuation">,</span>
  <span class="token string">'b-loader'</span><span class="token punctuation">,</span>
  <span class="token string">'c-loader'</span>
<span class="token punctuation">]</span>
<span class="token comment">// 当所有的loader的pitch方法都返回undefined时，正确的执行顺序如下</span>
<span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pitch</span><span class="token template-punctuation string">`</span></span>
  <span class="token operator">|</span><span class="token operator">-</span> b<span class="token operator">-</span>loader <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pitch</span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">|</span><span class="token operator">-</span> c<span class="token operator">-</span>loader <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pitch</span><span class="token template-punctuation string">`</span></span>
      <span class="token operator">|</span><span class="token operator">-</span> requested module is picked up <span class="token keyword">as</span> a dependency
    <span class="token operator">|</span><span class="token operator">-</span> c<span class="token operator">-</span>loader normal execution
  <span class="token operator">|</span><span class="token operator">-</span> b<span class="token operator">-</span>loader normal execution
<span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader normal execution
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p>如果某个loader的pitch方法返回一个非undefined的值，将会跳过剩余的loader。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  如果上面的b-loader返回一个结果，则执行顺序为</span>
<span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pitch</span><span class="token template-punctuation string">`</span></span>
  <span class="token operator">|</span><span class="token operator">-</span> b<span class="token operator">-</span>loader <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pitch</span><span class="token template-punctuation string">`</span></span> returns a module
<span class="token operator">|</span><span class="token operator">-</span> a<span class="token operator">-</span>loader normal execution
</code></pre></div><h4 id="_3-raw"><a href="#_3-raw" class="header-anchor">#</a> 3. raw</h4> <p>设置loader的raw属性为true,则内容变为二进制形式。针对图片，文件等。</p> <p>此时content.length就是文件的大小</p> <h3 id="_7-loader工具库中常见方法"><a href="#_7-loader工具库中常见方法" class="header-anchor">#</a> 7. loader工具库中常见方法</h3> <p>loader-utils： 内含各种处理loader的options的各种工具函数</p> <p>schema-utils: 用于校验loader和plugin的数据结构</p> <p>我们根据上面的要求，可以自己完成常见loader的实现。</p> <h4 id="_1-loaderutils-stringifyrequest-this-itemurl"><a href="#_1-loaderutils-stringifyrequest-this-itemurl" class="header-anchor">#</a> 1. loaderUtils.stringifyRequest(this, itemUrl)</h4> <p>将URL转为适合loader的相对路径</p> <div class="language- extra-class"><pre class="language-text"><code>/Users/lyralee/Desktop/MyStudy/React/loaders/loaders/css-loader.js!/Users/lyralee/Desktop/MyStudy/React/loaders/src/style.css
// 使用了loaderUtils.stringifyRequest(this, XXXX)方法后
&quot;../loaders/css-loader.js!./style.css&quot;
</code></pre></div><h4 id="_2-loaderutils-getoptions-this"><a href="#_2-loaderutils-getoptions-this" class="header-anchor">#</a> 2. loaderUtils.getOptions(this)</h4> <p>获取loader的options对象</p> <h4 id="_3-schemautils-schema-options"><a href="#_3-schemautils-schema-options" class="header-anchor">#</a> 3. schemaUtils(schema, options)</h4> <p>校验options的格式</p> <h3 id="_8-自模拟实现loader"><a href="#_8-自模拟实现loader" class="header-anchor">#</a> 8.自模拟实现loader</h3> <h4 id="_1-babel-loader-2"><a href="#_1-babel-loader-2" class="header-anchor">#</a> 1. babel-loader</h4> <p>简单的模拟实现babel-loader。它本身是基于@babel/core和其他插件和预设。</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>const babel = require('@babel/core');
const loaderUtils = require('loader-utils');
const path = require('path');

function loader(inputSource) {
  const loaderOptions = loaderUtils.getOptions(this);
  const options = {
    ...options,
    sourceMap: true, //是否生成映射
    filename: path.basename(this.resourcePath) //从路径中获取目标文件名
  }
  const {code, map, ast} = babel.transform(inputSource, loaderOptions);
  // 将内容传递给webpack
  /**
   * code: 处理后的字符串
   * map: 代码的source-map
   * ast: 生成的AST
   */
  this.callback(null, code, map, ast);
}
module.exports = loader;
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_2-banner-loader-2"><a href="#_2-banner-loader-2" class="header-anchor">#</a> 2. banner-loader</h4> <p>给解析的模块添加注释信息。该loader主要用于学习schema-utils的用法。</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>const babel = require('@babel/core');
// 获取loader的options
const loaderUtils = require('loader-utils');
// 校验loader的options
const validationOptions = require('schema-utils');
const fs = require('fs');

/**
 * 
 * @param {*} inputSource 
 * 该方法只接受内容作为入参，要注意使用该插件的顺序，
 * 如果在其他返回多个参数的loader之后接受参数，会丢失内容
 */
function loader(inputSource) {
  // 该loader启用缓存
  this.cacheable(); 
  // 用于异步操作中
  const callback = this.async();
  const schema = {
    type: 'object',
    properties: {
      text: { type: 'string' },
      filename: { type: 'string'}
    }
  }
  const options = loaderUtils.getOptions(this);
  // 校验options格式是否符合自定义的格式schema
  validationOptions(schema, options);
  const { code } = babel.transform(inputSource);
  // 读取外部文件，作为注释的内容
  fs.readFile(options.filename, 'utf8', (err, text) =&gt; {
    callback(null, options.text + text + code);
  })
}
module.exports = loader;
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <p>按照loader中的要求，options必须含有两个字段，filename和text,否则会报错</p> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>          {
            loader: 'banner-loader',
            options: {
              text: '/***lyra code ***/',
              filename: path.resolve(__dirname, 'banner.txt')
            }
          }
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_3-less-loader"><a href="#_3-less-loader" class="header-anchor">#</a> 3. less-loader</h4> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language- extra-class"><pre class="language-text"><code>const less = require('less');

module.exports = function(content) {
  const callback = this.async();
  less.render(content, {filename: this.resource}, (err, result) =&gt; {
    callback(null, result.css)
  })
}
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_4-css-loader-2"><a href="#_4-css-loader-2" class="header-anchor">#</a> 4. css-loader</h4> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 主要实现处理@import 和 url() 语法,基于postcss
 */</span>
 <span class="token comment">//通过js插件处理样式</span>
<span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// css选择器的词法分析器,用于解析和序列化css选择器</span>
<span class="token keyword">const</span> Tokenizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;css-selector-tokenizer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    importItems<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    urlItems<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">createPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>importItems<span class="token punctuation">,</span> urlItems<span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">let</span> requires <span class="token operator">=</span> importItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">itemUrl</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>itemUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// require(url)返回一个打包后的绝对路径</span>
    <span class="token keyword">let</span> cssstring <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>css<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_CSS_URL_(\d+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> g1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// &quot;background-image: url('&quot; + require('&quot; + url + &quot;')&quot;;</span>
      <span class="token keyword">return</span> <span class="token string">'&quot;+ require(&quot;'</span> <span class="token operator">+</span> urlItems<span class="token punctuation">[</span><span class="token operator">+</span>g1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'&quot;).default + &quot;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cssstring <span class="token operator">=</span> cssstring<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@import\s+['&quot;][^'&quot;]+['&quot;];</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requires<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssstring<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 自定义的js插件</span>
<span class="token keyword">function</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>urlItems<span class="token punctuation">,</span> importItems<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">css</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历@import规则</span>
    css<span class="token punctuation">.</span><span class="token function">walkAtRules</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^import$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      importItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历每一条样式</span>
    css<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解析样式属性的值</span>
      <span class="token keyword">const</span> values <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">parseValues</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      values<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'url'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
            item<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">&quot;_CSS_URL_&quot;</span> <span class="token operator">+</span> urlItems<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            urlItems<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>  
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 将解析后值返回序列化</span>
      decl<span class="token punctuation">.</span>value <span class="token operator">=</span> Tokenizer<span class="token punctuation">.</span><span class="token function">stringifyValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_5-style-loader"><a href="#_5-style-loader" class="header-anchor">#</a> 5.style-loader</h4> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">remainingRquest<span class="token punctuation">,</span> precedingRequest<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      const style = document.createElement('style');
      style.innerHTML = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'!!'</span> <span class="token operator">+</span> remainingRquest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
      document.head.appendChild(style);
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> script<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_6-file-loader"><a href="#_6-file-loader" class="header-anchor">#</a> 6. file-loader</h4> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 获取内容了；修改名称；在打包文件夹中输出
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> interpolateName<span class="token punctuation">,</span> getOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token operator">=</span><span class="token string">'[name].[hahs].[ext]'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> outFilename <span class="token operator">=</span> <span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>outFilename<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>outFilename<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// 内容二进制形式</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <h4 id="_7-url-loader"><a href="#_7-url-loader" class="header-anchor">#</a> 7.url-loader</h4> <p>[<img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码">](javascript:void(0)😉</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 当小于limit时，使用base64;
 * 当大于limit时，根据file-loader处理
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fileLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> <span class="token punctuation">{</span> limit<span class="token operator">=</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> base64 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports = &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base64<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">fileLoader</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/fish-vuePress/webpack/base.html">
        webpack基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fish-vuePress/assets/js/app.df5f89c4.js" defer></script><script src="/fish-vuePress/assets/js/5.edcfac08.js" defer></script><script src="/fish-vuePress/assets/js/2.3e0c97ad.js" defer></script>
  </body>
</html>
