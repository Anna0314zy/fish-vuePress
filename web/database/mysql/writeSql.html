<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何写优雅的SQL原生语句？ | 程序员成长指北</title>
    <meta name="description" content="一个用心帮助你成长的公众号">
    <link rel="shortcut icon" href="/favicon.ico" type="iamge/x-icon">
  <meta name="keywords" content="程序员成长指北 前端 公众号 koala 前端文章">
    
    <link rel="preload" href="/assets/css/0.styles.c7c2ec2a.css" as="style"><link rel="preload" href="/assets/js/app.c1ea5f09.js" as="script"><link rel="preload" href="/assets/js/3.9963a623.js" as="script"><link rel="preload" href="/assets/js/2.f88acf12.js" as="script"><link rel="preload" href="/assets/js/25.4ec7f5b3.js" as="script"><link rel="preload" href="/assets/js/7.bcc7ec58.js" as="script"><link rel="preload" href="/assets/js/10.fad53d07.js" as="script"><link rel="preload" href="/assets/js/5.aa7ac946.js" as="script"><link rel="prefetch" href="/assets/js/11.e0aeafd7.js"><link rel="prefetch" href="/assets/js/12.ed8e4581.js"><link rel="prefetch" href="/assets/js/13.f0b1e449.js"><link rel="prefetch" href="/assets/js/14.bf85a15c.js"><link rel="prefetch" href="/assets/js/15.0dabafe6.js"><link rel="prefetch" href="/assets/js/16.4a20ed9b.js"><link rel="prefetch" href="/assets/js/17.307c98b2.js"><link rel="prefetch" href="/assets/js/18.e1ae6326.js"><link rel="prefetch" href="/assets/js/19.471cbe98.js"><link rel="prefetch" href="/assets/js/20.b21ed2fc.js"><link rel="prefetch" href="/assets/js/21.888db290.js"><link rel="prefetch" href="/assets/js/22.3d1d8a9e.js"><link rel="prefetch" href="/assets/js/23.6fd5ec9f.js"><link rel="prefetch" href="/assets/js/24.8d525c63.js"><link rel="prefetch" href="/assets/js/26.9dcdcbed.js"><link rel="prefetch" href="/assets/js/27.c4062457.js"><link rel="prefetch" href="/assets/js/28.5cc9b84f.js"><link rel="prefetch" href="/assets/js/29.043d0c61.js"><link rel="prefetch" href="/assets/js/30.7d463ca2.js"><link rel="prefetch" href="/assets/js/31.e1c688ac.js"><link rel="prefetch" href="/assets/js/32.bf71bc22.js"><link rel="prefetch" href="/assets/js/33.f11c31b2.js"><link rel="prefetch" href="/assets/js/34.8330f211.js"><link rel="prefetch" href="/assets/js/35.67b30b06.js"><link rel="prefetch" href="/assets/js/36.1790b192.js"><link rel="prefetch" href="/assets/js/37.33c43309.js"><link rel="prefetch" href="/assets/js/38.9304a7bc.js"><link rel="prefetch" href="/assets/js/39.ee81b8d1.js"><link rel="prefetch" href="/assets/js/4.5f9c9106.js"><link rel="prefetch" href="/assets/js/40.0deb5e91.js"><link rel="prefetch" href="/assets/js/41.22655cfb.js"><link rel="prefetch" href="/assets/js/42.3eb237da.js"><link rel="prefetch" href="/assets/js/43.434a41a2.js"><link rel="prefetch" href="/assets/js/44.b509d32f.js"><link rel="prefetch" href="/assets/js/45.6e8d1e01.js"><link rel="prefetch" href="/assets/js/46.ae72ed23.js"><link rel="prefetch" href="/assets/js/47.78fa4ed4.js"><link rel="prefetch" href="/assets/js/48.93557007.js"><link rel="prefetch" href="/assets/js/49.5f3a95d9.js"><link rel="prefetch" href="/assets/js/50.2e675e8d.js"><link rel="prefetch" href="/assets/js/51.d72b8cb3.js"><link rel="prefetch" href="/assets/js/52.02d0c6b2.js"><link rel="prefetch" href="/assets/js/53.14bb49c3.js"><link rel="prefetch" href="/assets/js/54.3f0cac05.js"><link rel="prefetch" href="/assets/js/55.9b36f080.js"><link rel="prefetch" href="/assets/js/56.ca970554.js"><link rel="prefetch" href="/assets/js/57.ada970c6.js"><link rel="prefetch" href="/assets/js/58.e42ab1ea.js"><link rel="prefetch" href="/assets/js/59.cca8f1db.js"><link rel="prefetch" href="/assets/js/6.8e5bf519.js"><link rel="prefetch" href="/assets/js/60.73dcc633.js"><link rel="prefetch" href="/assets/js/61.9f416548.js"><link rel="prefetch" href="/assets/js/62.c35c5e12.js"><link rel="prefetch" href="/assets/js/63.b5fef24b.js"><link rel="prefetch" href="/assets/js/64.19bcb2d3.js"><link rel="prefetch" href="/assets/js/65.dbda1203.js"><link rel="prefetch" href="/assets/js/66.123d19c6.js"><link rel="prefetch" href="/assets/js/67.95cc5b0c.js"><link rel="prefetch" href="/assets/js/68.19a090d9.js"><link rel="prefetch" href="/assets/js/69.ab9e2298.js"><link rel="prefetch" href="/assets/js/70.3c285714.js"><link rel="prefetch" href="/assets/js/71.f4724ae4.js"><link rel="prefetch" href="/assets/js/72.188185b3.js"><link rel="prefetch" href="/assets/js/73.198ef35e.js"><link rel="prefetch" href="/assets/js/74.99449860.js"><link rel="prefetch" href="/assets/js/75.9d0cf97d.js"><link rel="prefetch" href="/assets/js/76.2ce1642f.js"><link rel="prefetch" href="/assets/js/77.61dcf7fd.js"><link rel="prefetch" href="/assets/js/78.dc2a4eb4.js"><link rel="prefetch" href="/assets/js/79.660749ab.js"><link rel="prefetch" href="/assets/js/8.cab2bbae.js"><link rel="prefetch" href="/assets/js/80.7ee44f37.js"><link rel="prefetch" href="/assets/js/81.305448ec.js"><link rel="prefetch" href="/assets/js/9.84c0b171.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c7c2ec2a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">程序员成长指北</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/webframe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/database/" class="nav-link router-link-active">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签云</a></div> <a href="https://github.com/koala-coding/goodBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/webframe/" class="nav-link">前端</a></div><div class="nav-item"><a href="/database/" class="nav-link router-link-active">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签云</a></div> <a href="https://github.com/koala-coding/goodBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="my_introduce" style="padding-left:1rem;"><div class="introduce_component" data-v-924f7e06><img src="/small.png" alt data-v-924f7e06> <div class="intro_content" data-v-924f7e06><h3 data-v-924f7e06>公众号:程序员成长指北</h3> <p data-v-924f7e06>koala 学习成长之路</p></div></div></div> <ul class="sidebar-links"><li><a href="/database/choice.html" class="sidebar-link">SQL 和 NoSQL 的区别与选择</a></li><li><a href="/database/mysql/baseFrame.html" class="sidebar-link">MySQL 基础架构你不知道的那些事</a></li><li><a href="/database/mysql/logSystem.html" class="sidebar-link">删库跑路后真的没有办法弥补了吗</a></li><li><a href="/database/mysql/optimize.html" class="sidebar-link">常用的数据库语句</a></li><li><a href="/database/mysql/writeSql.html" class="active sidebar-link">如何写优雅的SQL原生语句</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/mysql/writeSql.html#前言：" class="sidebar-link">前言：</a></li><li class="sidebar-sub-header"><a href="/database/mysql/writeSql.html#语句中各子句完整执行顺序概括（按照顺序号执行）" class="sidebar-link">语句中各子句完整执行顺序概括（按照顺序号执行）</a></li><li class="sidebar-sub-header"><a href="/database/mysql/writeSql.html#开发某需求写的一段sql" class="sidebar-link">开发某需求写的一段sql</a></li><li class="sidebar-sub-header"><a href="/database/mysql/writeSql.html#sql语句中的别名" class="sidebar-link">sql语句中的别名</a></li><li class="sidebar-sub-header"><a href="/database/mysql/writeSql.html#书写sql语句的注意事项" class="sidebar-link">书写sql语句的注意事项</a></li></ul></li><li><a href="/database/detail-redis1.html" class="sidebar-link">详细学习redis_入门篇</a></li><li><a href="/database/detail-redis2.html" class="sidebar-link">详细学习redis_进阶篇</a></li><li><a href="/database/detail-redis3.html" class="sidebar-link">详细学习redis_项目实战篇</a></li></ul> </aside> <main class="page"> <section class="page_title"><h1 class="def_title">如何写优雅的SQL原生语句？</h1> <div class="page_info"><span class="author"><img src="/images/icons/author_icon.png" alt> <span>koala</span></span> <span class="pub_time"><img src="/images/icons/time_icon.png" alt> <span>2019-5-26</span></span> <span class="tags"><img src="/images/icons/label_icon.png" alt> <a href="/tags/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93" class="tag">数据库</a></span></div></section> <div id="container" class="theme-default-content content__default"><h2 id="前言："><a href="#前言：" class="header-anchor">#</a> 前言：</h2> <p>上一篇讲Mysql基本架构时，以<code>sql</code>查询语句在MySql架构中具体是怎么执行的？”进行了全面的讲解。知道了sql查询语句在MySql架构中的具体执行流程，但是为了能够更好更快的写出sql语句，我觉得非常有必要知道sql语句中各子句的执行顺序。看过上一篇文章的小伙伴应该都知道，sql语句最后各子句的执行应该是在执行器中完成的，存储引擎对执行器提供的数据读写接口。现在开始我们的学习</p> <h2 id="语句中各子句完整执行顺序概括（按照顺序号执行）"><a href="#语句中各子句完整执行顺序概括（按照顺序号执行）" class="header-anchor">#</a> 语句中各子句完整执行顺序概括（按照顺序号执行）</h2> <ol><li>from (注:这里也包括from中的子语句)</li> <li>join</li> <li>on</li> <li>where</li> <li>group by(开始使用select中的别名，后面的语句中都可以使用)</li> <li>avg,sum.... 等聚合函数</li> <li>having</li> <li>select</li> <li>distinct</li> <li>order by</li> <li>limit</li></ol> <h3 id="每个子句执行顺序分析"><a href="#每个子句执行顺序分析" class="header-anchor">#</a> 每个子句执行顺序分析</h3> <p>所有的 查询语句都是从from开始执行的，在执行过程中，每个步骤都会为下一个步骤生成一个虚拟表，这个虚拟表将作为下一个执行步骤的输入。</p> <h4 id="_1-from"><a href="#_1-from" class="header-anchor">#</a> 1. from</h4> <p>form是一次查询语句的开端。</p> <ul><li>如果是一张表，会直接操作这张表；</li> <li>如果这个from后面是一个子查询，会先执行子查询中的内容，子查询的结果也就是第一个虚拟表T1。（注意：子查询中的执行流程也是按照本篇文章讲的顺序哦）。</li> <li>如果需要关联表，使用join，请看2，3</li></ul> <h4 id="_2-join"><a href="#_2-join" class="header-anchor">#</a> 2. join</h4> <p>如果from后面是多张表，join关联，会首先对前两个表执行一个笛卡尔乘积，这时候就会生成第一个虚拟表T1（注意：这里会选择相对小的表作为基础表）；</p> <h4 id="_3-on"><a href="#_3-on" class="header-anchor">#</a> 3.  on</h4> <p>对虚表T1进行ON筛选，只有那些符合<code>&lt;join-condition&gt;</code>的行才会被记录在虚表T2中。（注意，这里的这里如果还有第三个表与之关联，会用T2与第三个表进行笛卡尔乘积生产T3表，继续重复3. on步骤生成T4表，不过下面的顺序讲解暂时不针对这里的T3和T4，只是从一个表关联查询T2继续说）</p> <h4 id="_4-where"><a href="#_4-where" class="header-anchor">#</a> 4. where</h4> <p>对虚拟表T2进行WHERE条件过滤。只有符合<code>&lt;where-condition&gt;</code>的记录才会被插入到虚拟表T3中。</p> <h4 id="_5-group-by"><a href="#_5-group-by" class="header-anchor">#</a> 5.group by</h4> <p>group by 子句将中的唯一的值组合成为一组，得到虚拟表T4。如果应用了group by，那么后面的所有步骤都只能操作T4的列或者是执行6.聚合函数（count、sum、avg等）。（注意：原因在于分组后最终的结果集中只包含每个组中的一行。谨记，不然这里会出现很多问题，下面的代码误区会特别说。）</p> <h4 id="_6-avg-sum-等聚合函数"><a href="#_6-avg-sum-等聚合函数" class="header-anchor">#</a> 6. avg,sum.... 等聚合函数</h4> <p>聚合函数只是对分组的结果进行一些处理，拿到某些想要的聚合值，例如求和，统计数量等，并不生成虚拟表。</p> <h4 id="_7-having"><a href="#_7-having" class="header-anchor">#</a> 7.  having</h4> <p>应用having筛选器，生成T5。HAVING子句主要和GROUP BY子句配合使用，having筛选器是第一个也是为唯一一个应用到已分组数据的筛选器。</p> <h4 id="_8-select"><a href="#_8-select" class="header-anchor">#</a> 8.  select</h4> <p>执行select操作，选择指定的列，插入到虚拟表T6中。</p> <h4 id="_9-distinct"><a href="#_9-distinct" class="header-anchor">#</a> 9.  distinct</h4> <p>对T6中的记录进行去重。移除相同的行，产生虚拟表T7.（注意：事实上如果应用了group by子句那么distinct是多余的，原因同样在于，分组的时候是将列中唯一的值分成一组，同时只为每一组返回一行记录，那么所以的记录都将是不相同的。 ）</p> <h4 id="_10-order-by"><a href="#_10-order-by" class="header-anchor">#</a> 10. order by</h4> <p>应用order by子句。按照order_by_condition排序T7，此时返回的一个游标，而不是虚拟表。sql是基于集合的理论的，集合不会预先对他的行排序，它只是成员的逻辑集合，成员的顺序是无关紧要的。对表进行排序的查询可以返回一个对象，这个对象包含特定的物理顺序的逻辑组织。这个对象就叫游标。<br>
oder by的几点说明</p> <ul><li>因为order by返回值是游标，那么使用order by 子句查询不能应用于表表达式。</li> <li>order by排序是很需要成本的，除非你必须要排序，否则最好不要指定order by，</li> <li>order by的两个参数  asc（升序排列）  desc（降序排列）</li></ul> <h4 id="_11-limit"><a href="#_11-limit" class="header-anchor">#</a> 11. limit</h4> <p>取出指定行的记录，产生虚拟表T9, 并将结果返回。</p> <p>limit后面的参数可以是 一个limit m ，也可以是limit m n，表示从第m条到第n条数据。</p> <p>（注意：很多开发人员喜欢使用该语句来解决分页问题。对于小数据，使用LIMIT子句没有任何问题，当数据量非常大的时候，使用LIMIT n, m是非常低效的。因为LIMIT的机制是每次都是从头开始扫描，如果需要从第60万行开始，读取3条数据，就需要先扫描定位到60万行，然后再进行读取，而扫描的过程是一个非常低效的过程。所以，对于大数据处理时，是非常有必要在应用层建立一定的缓存机制）</p> <h2 id="开发某需求写的一段sql"><a href="#开发某需求写的一段sql" class="header-anchor">#</a> 开发某需求写的一段sql</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>avatar<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>user_avatar<span class="token punctuation">`</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>answer_record<span class="token punctuation">`</span><span class="token punctuation">,</span> 
 <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token punctuation">`</span>score<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> pkrecord  <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> a 
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span> 
<span class="token keyword">ON</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token operator">AND</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">!=</span> <span class="token string">'m_6da5d9e0-4629-11e9-b5f7-694ced396953'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>a<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token keyword">DESC</span> 
<span class="token keyword">LIMIT</span> <span class="token number">9</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>查询结果：</p> <p><img src="http://img.xiaogangzai.cn/sql_16b0ea85ba531a1a.png" alt=""></p> <ul><li>先简要说一下我要查询的内容：</li></ul> <p>想要查询pk记录表中分数最高的9个用户记录和他们的头像。</p> <ul><li>通过这段sql实际想一遍sql各字句的执行顺序</li></ul> <p>pk记录表的数据结构设计，每个用户每天每个馆下可能会有多条记录，所以需要进行分组，并且<strong>查询结果只想拿到每个分组内最高的那条记录</strong>。</p> <p>这段sql的一些说明：</p> <ol><li>可能有些同学会认为子查询没有必要
直接查询pk记录表就可以，但是并不能拿到预期的结果，因为<strong>分组后的每个组结果是不进行排序的</strong>，而且max拿到的最高分数肯定是对应的该分组下最高分数，但是其它记录可能就不是最高分数对应的那条记录。所以子查询非常有必要，<strong>它能够对原始的数据首先进行排序</strong>，分数最高的那条就是第一条对应的第一条记录。</li></ol> <p>看一下代码和执行结果与带有子查询的进行比较，就能理解我上面说的一段话：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//不使用子查询</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>avatar<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>user_avatar<span class="token punctuation">`</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>answer_record<span class="token punctuation">`</span><span class="token punctuation">,</span> 
<span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> 
 <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token punctuation">`</span>score<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> pkrecord
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span> 
<span class="token keyword">ON</span> <span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>userspk<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token operator">AND</span> <span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">!=</span> <span class="token string">'m_6da5d9e0-4629-11e9-b5f7-694ced396953'</span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>pkrecord<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token keyword">DESC</span> 
<span class="token keyword">LIMIT</span> <span class="token number">9</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>查询结果
<img src="https://user-gold-cdn.xitu.io/2019/6/1/16b0ea8fae4441e6?w=920&amp;h=116&amp;f=png&amp;s=27790" alt=""></p> <ol start="2"><li>在子查询中对数据已经进行排序后，外层排序方式如果和子查询排序分数相同，都是分数倒序，外层的排序可以去掉，没有必要写两遍。</li></ol> <h2 id="sql语句中的别名"><a href="#sql语句中的别名" class="header-anchor">#</a> sql语句中的别名</h2> <h4 id="别名在哪些情况使用"><a href="#别名在哪些情况使用" class="header-anchor">#</a> 别名在哪些情况使用</h4> <p>在 SQL 语句中，可以为表名称及字段（列）名称指定别名</p> <ul><li>表名称指定别名</li></ul> <p>同时查询两张表的数据的时候：
未设置别名前：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> article<span class="token punctuation">.</span>title<span class="token punctuation">,</span>article<span class="token punctuation">.</span>content<span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">.</span>username <span class="token keyword">FROM</span> article<span class="token punctuation">,</span> <span class="token keyword">user</span>

<span class="token keyword">WHERE</span> article<span class="token punctuation">.</span>aid<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> article<span class="token punctuation">.</span>uid<span class="token operator">=</span><span class="token keyword">user</span><span class="token punctuation">.</span>uid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>设置别名后：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>title<span class="token punctuation">,</span>a<span class="token punctuation">.</span>content<span class="token punctuation">,</span>u<span class="token punctuation">.</span>username <span class="token keyword">FROM</span> article <span class="token keyword">AS</span> a<span class="token punctuation">,</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u <span class="token keyword">where</span> a<span class="token punctuation">.</span>aid<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>uid<span class="token operator">=</span>u<span class="token punctuation">.</span>uid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>好处：使用表别名查询，可以使 SQL 变得简洁而更易书写和阅读，尤其在 SQL 比较复杂的情况下</p> <ul><li>查询字段指定别名</li></ul> <p>查询一张表，直接对查询字段设置别名</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> username <span class="token keyword">AS</span> name<span class="token punctuation">,</span>email <span class="token keyword">FROM</span> <span class="token keyword">user</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询两张表</p> <p>好处：字段别名一个明显的效果是可以自定义查询数据返回的字段名；当两张表有相同的字段需要都被查询出，使用别名可以完美的进行区分，避免冲突</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>title <span class="token keyword">AS</span> atitle<span class="token punctuation">,</span>u<span class="token punctuation">.</span>username<span class="token punctuation">,</span>u<span class="token punctuation">.</span>title <span class="token keyword">AS</span> utitle <span class="token keyword">FROM</span> article <span class="token keyword">AS</span> a<span class="token punctuation">,</span> <span class="token keyword">user</span> <span class="token keyword">AS</span> u <span class="token keyword">where</span> a<span class="token punctuation">.</span>uid<span class="token operator">=</span>u<span class="token punctuation">.</span>uid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>关联查询时候，关联表自身的时候，一些分类表，必须使用别名。</p></li> <li><p>别名也可以在group         by与having的时候都可使用</p></li> <li><p>别名可以在order by排序的时候被使用</p> <p>查看上面一段sql</p></li> <li><p>delete ， update MySQL都可以使用别名，别名在多表（级联）删除尤为有用</p></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">delete</span> t1<span class="token punctuation">,</span>t2 <span class="token keyword">from</span> t_a t1 <span class="token punctuation">,</span> t_b t2 <span class="token keyword">where</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>子查询结果需要使用别名</p> <p>查看上面一段sql</p></li></ul> <h4 id="别名使用注意事项"><a href="#别名使用注意事项" class="header-anchor">#</a> 别名使用注意事项</h4> <ul><li>虽然定义字段别名的 AS 关键字可以省略，但是在使用别名时候，建议不要省略 AS 关键字</li></ul> <h2 id="书写sql语句的注意事项"><a href="#书写sql语句的注意事项" class="header-anchor">#</a> 书写sql语句的注意事项</h2> <h4 id="书写规范上的注意"><a href="#书写规范上的注意" class="header-anchor">#</a> 书写规范上的注意</h4> <ul><li>字符串类型的要加单引号</li> <li>select后面的每个字段要用逗号分隔，但是最后连着from的字段不要加逗号</li> <li>使用子查询创建临时表的时候要使用别名，否则会报错。</li></ul> <h4 id="为了增强性能的注意"><a href="#为了增强性能的注意" class="header-anchor">#</a> 为了增强性能的注意</h4> <ul><li>不要使用“select * from ……”返回所有列，只检索需要的列，可避免后续因表结构变化导致的不必要的程序修改，还可降低额外消耗的资源</li> <li>不要检索已知的列</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>select  user_id,name from User where user_id = ‘10000050’
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用可参数化的搜索条件，如=, &gt;, &gt;=, &lt;, &lt;=, between, in, is null以及like ‘<code>&lt;literal&gt;%</code>’；尽量不要使用非参数化的负向查询，这将导致无法使用索引，如&lt;&gt;, !=, !&gt;, !&lt;, not in, not like, not exists, not between, is not null, like ‘%<code>&lt;literal&gt;</code>’</li> <li>当需要验证是否有符合条件的记录时，使用exists，不要使用count(*)，前者在第一个匹配记录处返回，后者需要遍历所有匹配记录</li> <li>Where子句中列的顺序与需使用的索引顺序保持一致，不是所有数据库的优化器都能对此顺序进行优化，保持良好编程习惯（索引相关）</li> <li>不要在where子句中对字段进行运算或函数（索引相关）</li></ul> <ol><li>如where  amount / 2 &gt; 100，即使amount字段有索引，也无法使用，改成where amount &gt; 100 * 2就可使用amount列上的索引</li> <li>如where substring( Lastname, 1, 1) = ‘F’就无法使用Lastname列上的索引，而where Lastname like ‘F%’或者where Lastname &gt;= ‘F’ and Lastname &lt; ‘G’就可以</li></ol> <ul><li><p>在有min、max、distinct、order by、group by操作的列上建索引，避免额外的排序开销（索引相关）</p></li> <li><p>小心使用or操作，and操作中任何一个子句可使用索引都会提高查询性能，但是or条件中任何一个不能使用索引，都将导致查询性能下降，如where member_no = 1 or provider_no = 1，在member_no或provider_no任何一个字段上没有索引，都将导致表扫描或聚簇索引扫描（索引相关）</p></li> <li><p>Between一般比in/or高效得多，如果能在between和in/or条件中选择，那么始终选择between条件，并用&gt;=和&lt;=条件组合替代between子句，因为不是所有数据库的优化器都能把between子句改写为&gt;=和&lt;=条件组合，如果不能改写将导致无法使用索引（索引相关）</p></li> <li><p>调整join操作顺序以使性能最优，join操作是自顶向下的，尽量把结果集小的两个表关联放在前面，可提高性能。（join相关）
注意：索引和关联我会单独拿出来两篇文章进行详细讲解，在这个注意事项中只是简单提一下。</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/database/mysql/optimize.html" class="prev">常用的数据库语句</a></span> <span class="next"><a href="/database/detail-redis1.html">详细学习redis_入门篇</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><div class="qrcode_container" data-v-2e99e6c4><div class="tencent_code" data-v-2e99e6c4><h4 data-v-2e99e6c4>关注作者公众</h4> <p data-v-2e99e6c4>和万千小伙伴一起学习</p> <img src="/ggh.jpg" alt data-v-2e99e6c4></div> <div class="group_code" data-v-2e99e6c4><h4 data-v-2e99e6c4>加入技术交流群</h4> <p data-v-2e99e6c4>扫描二维码 备注<span data-v-2e99e6c4> 加群</span></p> <img src="/wechat.jpg" alt data-v-2e99e6c4></div></div><!----></div></div>
    <script src="/assets/js/app.c1ea5f09.js" defer></script><script src="/assets/js/3.9963a623.js" defer></script><script src="/assets/js/2.f88acf12.js" defer></script><script src="/assets/js/25.4ec7f5b3.js" defer></script><script src="/assets/js/7.bcc7ec58.js" defer></script><script src="/assets/js/10.fad53d07.js" defer></script><script src="/assets/js/5.aa7ac946.js" defer></script>
  </body>
</html>
