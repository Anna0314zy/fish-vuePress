<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js核心模块-buffer | 小鱼儿的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="专注前端技术栈分享,从前端到Node.js再到数据库">
    
    <link rel="preload" href="/fish-vuePress/assets/css/0.styles.661cc1b3.css" as="style"><link rel="preload" href="/fish-vuePress/assets/js/app.7db4e227.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/2.b13c1c09.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/1.e752e41e.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/76.8a74b839.js" as="script"><link rel="prefetch" href="/fish-vuePress/assets/js/10.ceac55a7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/100.2bf3dec1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/101.41b757c9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/102.554c41f6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/103.8cb27d26.js"><link rel="prefetch" href="/fish-vuePress/assets/js/104.f02137f3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/105.abbe6470.js"><link rel="prefetch" href="/fish-vuePress/assets/js/106.a7a388fa.js"><link rel="prefetch" href="/fish-vuePress/assets/js/107.8af08d25.js"><link rel="prefetch" href="/fish-vuePress/assets/js/108.b6ff9992.js"><link rel="prefetch" href="/fish-vuePress/assets/js/109.762ea126.js"><link rel="prefetch" href="/fish-vuePress/assets/js/11.ec9bd2be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/110.927eb467.js"><link rel="prefetch" href="/fish-vuePress/assets/js/111.adc4acb4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/112.130b6d37.js"><link rel="prefetch" href="/fish-vuePress/assets/js/113.9d7ca173.js"><link rel="prefetch" href="/fish-vuePress/assets/js/114.77344bff.js"><link rel="prefetch" href="/fish-vuePress/assets/js/115.89733bdc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/116.874a6cc6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/117.7aaeb7f5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/118.0a179db8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/119.c6d07158.js"><link rel="prefetch" href="/fish-vuePress/assets/js/12.2628bb41.js"><link rel="prefetch" href="/fish-vuePress/assets/js/120.0b6940d1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/121.5bf20be8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/122.83289fc4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/123.6daf47eb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/124.089fecff.js"><link rel="prefetch" href="/fish-vuePress/assets/js/125.8dba6703.js"><link rel="prefetch" href="/fish-vuePress/assets/js/126.9216202c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/127.e458cd9c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/128.9f22b0ed.js"><link rel="prefetch" href="/fish-vuePress/assets/js/129.2575d138.js"><link rel="prefetch" href="/fish-vuePress/assets/js/13.21baa93c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/130.0a5c5f7d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/131.aedcdddd.js"><link rel="prefetch" href="/fish-vuePress/assets/js/132.ccff1de2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/133.6a78d994.js"><link rel="prefetch" href="/fish-vuePress/assets/js/134.3b6226c8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/135.aa20e7b0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/136.62f2eacf.js"><link rel="prefetch" href="/fish-vuePress/assets/js/137.4998600f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/138.7de8fc50.js"><link rel="prefetch" href="/fish-vuePress/assets/js/139.1adbc6d7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/14.9d819ab5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/140.89ab1934.js"><link rel="prefetch" href="/fish-vuePress/assets/js/141.80a1eccf.js"><link rel="prefetch" href="/fish-vuePress/assets/js/142.c1982beb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/143.a7edeaf3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/144.3e74de50.js"><link rel="prefetch" href="/fish-vuePress/assets/js/145.272e58f9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/146.dff80155.js"><link rel="prefetch" href="/fish-vuePress/assets/js/147.110b58a6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/148.8bf060e7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/149.574ba474.js"><link rel="prefetch" href="/fish-vuePress/assets/js/15.213907d2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/150.8133f0b4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/151.6947a6c1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/152.b49c04e9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/16.223e831f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/17.ee0c21d9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/18.ea95e2da.js"><link rel="prefetch" href="/fish-vuePress/assets/js/19.b8e8fe3d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/20.0d5d355c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/21.eec4084f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/22.c64f8146.js"><link rel="prefetch" href="/fish-vuePress/assets/js/23.808ac485.js"><link rel="prefetch" href="/fish-vuePress/assets/js/24.50d0c55a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/25.3cf3b98f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/26.d0825f45.js"><link rel="prefetch" href="/fish-vuePress/assets/js/27.fd33c51c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/28.c4d721bd.js"><link rel="prefetch" href="/fish-vuePress/assets/js/29.6d8043ea.js"><link rel="prefetch" href="/fish-vuePress/assets/js/3.b9aa9360.js"><link rel="prefetch" href="/fish-vuePress/assets/js/30.cff3c403.js"><link rel="prefetch" href="/fish-vuePress/assets/js/31.563442e1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/32.3e857e07.js"><link rel="prefetch" href="/fish-vuePress/assets/js/33.203f464d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/34.73f04131.js"><link rel="prefetch" href="/fish-vuePress/assets/js/35.0fd8005c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/36.1e47204e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/37.715f9d75.js"><link rel="prefetch" href="/fish-vuePress/assets/js/38.c51cc576.js"><link rel="prefetch" href="/fish-vuePress/assets/js/39.cc2fd898.js"><link rel="prefetch" href="/fish-vuePress/assets/js/4.1d4a232f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/40.2b43d43c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/41.248a4042.js"><link rel="prefetch" href="/fish-vuePress/assets/js/42.ff3bad7f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/43.a226aca4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/44.9b55dcc1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/45.fe91c9ef.js"><link rel="prefetch" href="/fish-vuePress/assets/js/46.fdb56651.js"><link rel="prefetch" href="/fish-vuePress/assets/js/47.19166713.js"><link rel="prefetch" href="/fish-vuePress/assets/js/48.d3f47361.js"><link rel="prefetch" href="/fish-vuePress/assets/js/49.442b28f2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/5.c9b4e5f8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/50.7ff7f865.js"><link rel="prefetch" href="/fish-vuePress/assets/js/51.3be9fc20.js"><link rel="prefetch" href="/fish-vuePress/assets/js/52.e36e6708.js"><link rel="prefetch" href="/fish-vuePress/assets/js/53.69d8ea45.js"><link rel="prefetch" href="/fish-vuePress/assets/js/54.fe436ea5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/55.9217fc35.js"><link rel="prefetch" href="/fish-vuePress/assets/js/56.8feee271.js"><link rel="prefetch" href="/fish-vuePress/assets/js/57.12650c93.js"><link rel="prefetch" href="/fish-vuePress/assets/js/58.071c93ef.js"><link rel="prefetch" href="/fish-vuePress/assets/js/59.3fffe4f8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/6.0d6e493b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/60.bace2f13.js"><link rel="prefetch" href="/fish-vuePress/assets/js/61.f96c717a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/62.906dff5c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/63.fa105036.js"><link rel="prefetch" href="/fish-vuePress/assets/js/64.1d5864ab.js"><link rel="prefetch" href="/fish-vuePress/assets/js/65.7a01bcb0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/66.1d3662e1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/67.47b07d5b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/68.e4abc45f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/69.a36ba76e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/7.e2256ca0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/70.5b11a939.js"><link rel="prefetch" href="/fish-vuePress/assets/js/71.7bcc1da1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/72.c0fdbf98.js"><link rel="prefetch" href="/fish-vuePress/assets/js/73.19ea22d4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/74.e524c883.js"><link rel="prefetch" href="/fish-vuePress/assets/js/75.aba02964.js"><link rel="prefetch" href="/fish-vuePress/assets/js/77.7db38eeb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/78.03a73328.js"><link rel="prefetch" href="/fish-vuePress/assets/js/79.450f5e2a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/80.b98a4dc7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/81.b5d2b1f2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/82.28ec7eb0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/83.0b631f9e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/84.d7ca52eb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/85.548308df.js"><link rel="prefetch" href="/fish-vuePress/assets/js/86.4abe63bc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/87.59163c55.js"><link rel="prefetch" href="/fish-vuePress/assets/js/88.cd511741.js"><link rel="prefetch" href="/fish-vuePress/assets/js/89.8de84f04.js"><link rel="prefetch" href="/fish-vuePress/assets/js/90.8fa45f89.js"><link rel="prefetch" href="/fish-vuePress/assets/js/91.614490d0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/92.b82984be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/93.d23c5f71.js"><link rel="prefetch" href="/fish-vuePress/assets/js/94.eecb124d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/95.4561e68c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/96.91baeb5e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/97.dc8e4090.js"><link rel="prefetch" href="/fish-vuePress/assets/js/98.bf369fae.js"><link rel="prefetch" href="/fish-vuePress/assets/js/99.1f8b96a2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/vendors~docsearch.ee560901.js">
    <link rel="stylesheet" href="/fish-vuePress/assets/css/0.styles.661cc1b3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fish-vuePress/" class="home-link router-link-active"><!----> <span class="site-name">小鱼儿的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link">
  webpack
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link">
  webpack
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fish-vuePress/node/" aria-current="page" class="sidebar-link">node目录</a></li><li><a href="/fish-vuePress/node/promise.html" class="sidebar-link">深度了解promise</a></li><li><a href="/fish-vuePress/node/what.html" class="sidebar-link">node.js究竟是什么</a></li><li><a href="/fish-vuePress/node/event_loop.html" class="sidebar-link">node事件循环</a></li><li><a href="/fish-vuePress/node/util.html" class="sidebar-link">node-模块util</a></li><li><a href="/fish-vuePress/node/path.html" class="sidebar-link">node核心模块-path</a></li><li><a href="/fish-vuePress/node/module_fs.html" class="sidebar-link">node核心模块-fs</a></li><li><a href="/fish-vuePress/node/stream.html" class="sidebar-link">node核心模块-stream</a></li><li><a href="/fish-vuePress/node/buffer.html" aria-current="page" class="active sidebar-link">node核心模块-buffer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer探究" class="sidebar-link">Buffer探究</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#什么是二进制" class="sidebar-link">什么是二进制</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#node中为什么会出现buffer这个模块" class="sidebar-link">node中为什么会出现Buffer这个模块</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer创建" class="sidebar-link">Buffer创建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的buffer" class="sidebar-link" style="padding-left:3rem;">1. Buffer.alloc 和 Buffer.allocUnsafe(创建固定大小的buffer)</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#_2、buffer-from-根据内容直接创建buffer" class="sidebar-link" style="padding-left:3rem;">2、Buffer.from(根据内容直接创建Buffer)</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer的内存分配机制" class="sidebar-link">Buffer的内存分配机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#内存分配的8k机制" class="sidebar-link" style="padding-left:3rem;">内存分配的8K机制</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer内存分配机制优点" class="sidebar-link" style="padding-left:3rem;">buffer内存分配机制优点</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer与stream" class="sidebar-link">Buffer与stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#stream的流动为什么要使用二进制buffer" class="sidebar-link" style="padding-left:3rem;">stream的流动为什么要使用二进制Buffer</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#buffer在stream数据流转充当的角色" class="sidebar-link" style="padding-left:3rem;">Buffer在stream数据流转充当的角色</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node/buffer.html#关注我" class="sidebar-link">关注我</a></li></ul></li></ul></li><li><a href="/fish-vuePress/node/processAndThread.html" class="sidebar-link">深入理解进程与线程</a></li><li><a href="/fish-vuePress/node/queue.html" class="sidebar-link">Node.js中的消息队列</a></li><li><a href="/fish-vuePress/node/overflow.html" class="sidebar-link">Node.js 内存溢出时如何处理？</a></li><li><a href="/fish-vuePress/node/events.html" class="sidebar-link">[源码解读]一文彻底搞懂Events模块</a></li><li><a href="/fish-vuePress/node/errors.html" class="sidebar-link">nodejs十个常见误区</a></li><li><a href="/fish-vuePress/node/AsyncIO.html" class="sidebar-link">Node 与底层之间如何执行异步 I/O 调用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>前言</strong></p> <p>写完上一篇文章<a href="/fish-vuePress/node/stream.html">想学Node.js，stream先有必要搞清楚</a>
留下了悬念，<code>stream</code>对象数据流转的具体内容是什么？本篇文章将为大家进行深入讲解。</p> <h2 id="buffer探究"><a href="#buffer探究" class="header-anchor">#</a> Buffer探究</h2> <p>看一段之前使用<code>stream</code>操作文件的例子：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stream<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stream内容'</span><span class="token punctuation">,</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>  
stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk <span class="token keyword">instanceof</span> <span class="token class-name">Buffer</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>看一下打印结果，发现第一个stream是一个对象 ，截图部分内容。</p> <p>(http://img.xiaogangzai.cn/node_buffer_07.jpg)
第二个和第三个打印结果，</p> <p>(http://img.xiaogangzai.cn/node_buffer_08.jpg)
Buffer对象，类似数组，它的元素为16进制的两位数，即0到255的数值。可以看出stream中流动的数据是Buffer类型，二进制数据，接下来开始我们的Buffer探索之旅。</p> <h2 id="什么是二进制"><a href="#什么是二进制" class="header-anchor">#</a> 什么是二进制</h2> <p>二进制是计算机最底层的数据格式，字符串，数字，视频，音频，程序，网络包等，在最底层都是用二进制来进行存储。这些高级格式和二进制之间，都可以通过固定的编码格式进行相互转换。</p> <p>例如，C语言中int32类型的十进制整数（无符号），就占用32bit即4byte，十进制的3对应的二进制就是<code>00000000 00000000 00000000 00000011</code>。字符串也是同理，可以根据ASCII编码规则或者unicode编码规则（如utf-8）等和二进制进行相互转换。总之，计算机底层存储的数据都是二进制格式，各种高级类型都有对应的编码规则和二进制进行相互转换。</p> <h2 id="node中为什么会出现buffer这个模块"><a href="#node中为什么会出现buffer这个模块" class="header-anchor">#</a> node中为什么会出现Buffer这个模块</h2> <p>在最初的<code>javascript</code>生态中，<code>javascript</code>还运行在浏览器端，对于处理Unicode编码的字符串数据很容易，但是对于处理二进制以及非<code>Unicode</code>编码的数据无能为力，但是对于<code>Server</code>端操作<code>TCP/HTTP</code>以及<code>文件I/O</code>的处理是必须的。我想就是因此在<code>Node.js</code>里面提供了<code>Buffer</code>类处理二进制的数据，可以处理各种类型的数据。</p> <p>Buffer模块的一个说明。</p> <blockquote><p>在Node.js里面一些重要模块net、http、fs中的数据传输以及处理都有Buffer的身影，因为一些基础的核心模块都要依赖Buffer，所以在node启动的时候，就已经加载了Buffer，我们可以在全局下面直接使用Buffer，无需通过require()。且 Buffer 的大小在创建时确定，无法调整。</p></blockquote> <h2 id="buffer创建"><a href="#buffer创建" class="header-anchor">#</a> Buffer创建</h2> <p>在 <code>NodeJS v6.0.0</code>版本之前，<code>Buffer</code>实例是通过 Buffer 构造函数创建的，即使用 new 关键字创建，它根据提供的参数返回不同的 Buffer，但在之后的版本中这种声明方式就被废弃了，替代 new 的创建方式主要有以下几种。</p> <h4 id="_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的buffer"><a href="#_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的buffer" class="header-anchor">#</a> 1. Buffer.alloc 和 Buffer.allocUnsafe(创建固定大小的buffer)</h4> <p>用 <code>Buffer.alloc</code> 和 <code>Buffer.allocUnsafe</code> 创建 Buffer 的传参方式相同，参数为创建 Buffer 的长度，数值类型。</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// Buffer.alloc 和 Buffer.allocUnsafe 创建 Buffer</span>
<span class="token comment">// Buffer.alloc 创建 Buffer,创建一个大小为6字节的空buffer，经过了初始化</span>
<span class="token keyword">let</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Buffer.allocUnsafe 创建 Buffer，创建一个大小为6字节的buffer，未经过初始化</span>
<span class="token keyword">let</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">allocUnsafe</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 00 00 00 00 00 00&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 00 e7 8f a0 00 00&gt;</span>
</code></pre></div><p>通过代码可以看出，用 <code>Buffer.alloc</code> 和 <code>Buffer.allocUnsafe</code> 创建<code>Buffer</code> 是有区别的，<code>Buffer.alloc</code> 创建的 <code>Buffer</code> 是被初始化过的，即 <code>Buffer</code> 的每一项都用 00 填充，而 <code>Buffer.allocUnsafe</code> 创建的 Buffer 并没有经过初始化，在内存中只要有闲置的 Buffer 就直接 “抓过来” 使用。</p> <p><code>Buffer.allocUnsafe</code> 创建 <code>Buffer</code> 使得内存的分配非常快，但已分配的内存段可能包含潜在的敏感数据，有明显性能优势的同时又是不安全的，所以使用需格外 “小心”。</p> <h4 id="_2、buffer-from-根据内容直接创建buffer"><a href="#_2、buffer-from-根据内容直接创建buffer" class="header-anchor">#</a> 2、Buffer.from(根据内容直接创建Buffer)</h4> <blockquote><p>Buffer.from(str,  )
支持三种传参方式：</p></blockquote> <ul><li>第一个参数为字符串，第二个参数为字符编码，如 <code>ASCII</code>、<code>UTF-8</code>、<code>Base64</code> 等等。</li> <li>传入一个数组，数组的每一项会以十六进制存储为 <code>Buffer</code> 的每一项。</li> <li>传入一个<code>Buffer</code>，会将 <code>Buffer</code> 的每一项作为新返回 <code>Buffer</code> 的每一项。</li></ul> <p><strong>说明:<code>Buffer</code>目前支持的编码格式</strong></p> <ul><li>ascii - 仅支持7位ASCII数据。</li> <li>utf8 - 多字节编码的Unicode字符</li> <li>utf16le - 2或4个字节，小端编码的Unicode字符</li> <li>base64 - Base64字符串编码</li> <li>binary - 二进制编码。</li> <li>hex - 将每个字节编码为两个十六进制字符。</li></ul> <h5 id="传入字符串和字符编码"><a href="#传入字符串和字符编码" class="header-anchor">#</a> 传入字符串和字符编码：</h5> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 传入字符串和字符编码</span>
<span class="token keyword">let</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f&gt;</span>
</code></pre></div><h5 id="传入数组"><a href="#传入数组" class="header-anchor">#</a> 传入数组：</h5> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 数组成员为十进制数</span>
<span class="token keyword">let</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 01 02 03&gt;</span>
</code></pre></div><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 数组成员为十六进制数</span>
<span class="token keyword">let</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xe4</span><span class="token punctuation">,</span> <span class="token number">0xbd</span><span class="token punctuation">,</span> <span class="token number">0xa0</span><span class="token punctuation">,</span> <span class="token number">0xe5</span><span class="token punctuation">,</span> <span class="token number">0xa5</span><span class="token punctuation">,</span> <span class="token number">0xbd</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer e4 bd a0 e5 a5 bd&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你好</span>
</code></pre></div><p>在 <code>NodeJS</code> 中不支持 <code>GB2312</code> 编码，默认支持 <code>UTF-8</code>，在 <code>GB2312</code> 中，一个汉字占两个字节，而在 <code>UTF-8</code> 中，<code>一个汉字</code>占三个字节，所以上面 “你好” 的 <code>Buffer</code> 为 6 个十六进制数组成。</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 数组成员为字符串类型的数字</span>
<span class="token keyword">let</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 01 02 03&gt;</span>
</code></pre></div><p>传入的数组成员可以是任何进制的数值，当成员为字符串的时候，如果值是数字会被自动识别成数值类型，如果值不是数字或成员为是其他非数值类型的数据，该成员会被初始化为 00。</p> <p>创建的 <code>Buffer</code> 可以通过 <code>toString</code> 方法直接指定编码进行转换，默认编码为 <code>UTF-8</code>。</p> <h5 id="传入-buffer"><a href="#传入-buffer" class="header-anchor">#</a> 传入 Buffer：</h5> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 传入一个 Buffer</span>
<span class="token keyword">let</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1 <span class="token operator">===</span> buf2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> buf2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
buf1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 0c 6c 6c 6f&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f&gt;</span>
</code></pre></div><p>当传入的参数为一个 <code>Buffer</code> 的时候，会创建一个新的 <code>Buffer</code> 并复制上面的每一个成员。</p> <p><code>Buffer</code> 为引用类型，一个 <code>Buffer</code> 复制了另一个 Buffer 的成员，当其中一个 Buffer 复制的成员有更改，另一个 Buffer 对应的成员不会跟着改变，说明传入<code>buffer</code>创建新的<code>Buffer</code>的时候是一个深拷贝的过程。</p> <h2 id="buffer的内存分配机制"><a href="#buffer的内存分配机制" class="header-anchor">#</a> Buffer的内存分配机制</h2> <p><strong>buffer对应于 V8 堆内存之外的一块原始内存</strong></p> <p><code>Buffer</code>是一个典型的<code>javascript</code>与<code>C++</code>结合的模块，与性能有关的用C++来实现，<code>javascript</code> 负责衔接和提供接口。<code>Buffer</code>所占的内存不是<code>V8</code>堆内存，是独立于<code>V8</code>堆内存之外的内存，通过<code>C++</code>层面实现内存申请（可以说真正的内存是<code>C++</code>层面提供的）、<code>javascript</code> 分配内存（可以说<code>JavaScript</code>层面只是使用它）。<code>Buffer</code>在分配内存最终是使用<code>ArrayBuffer</code>对象作为载体。简单点而言， 就是<code>Buffer</code>模块使用<code>v8::ArrayBuffer</code>分配一片内存，通过<code>TypedArray</code>中的<code>v8::Uint8Array</code>来去写数据。</p> <h4 id="内存分配的8k机制"><a href="#内存分配的8k机制" class="header-anchor">#</a> 内存分配的8K机制</h4> <ul><li>分配小内存</li></ul> <p>说道Buffer的内存分配就不得不说<code>Buffer</code>的<code>8KB</code>的问题，对应<code>buffer.js</code>源码里面的处理如下：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>Buffer<span class="token punctuation">.</span>poolSize <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FastBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">&lt;</span> Buffer<span class="token punctuation">.</span>poolSize <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> poolSize <span class="token operator">-</span> poolOffset<span class="token punctuation">)</span>
            <span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> b <span class="token operator">=</span> allocPool<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>poolOffset<span class="token punctuation">,</span>poolOffset <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        poolOffset <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        <span class="token function">alignPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createUnsafeBuffer</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源码直接看来就是以8KB作为界限，如果写入的数据大于8KB一半的话直接则直接去分配内存，如果小于4KB的话则从当前分配池里面判断是否够空间放下当前存储的数据，如果不够则重新去申请8KB的内存空间，把数据存储到新申请的空间里面，如果足够写入则直接写入数据到内存空间里面，下图为其内存分配策略。</p> <p><img src="http://img.xiaogangzai.cn/node_buffer_09.jpg" alt="Buffer内存分配策略图">
看内存分配策略图，如果当前存储了2KB的数据，后面要存储5KB大小数据的时候分配池判断所需内存空间大于4KB，则会去重新申请内存空间来存储5KB数据并且分配池的当前偏移指针也是指向新申请的内存空间，这时候就之前剩余的6KB(8KB-2KB)内存空间就会被搁置。至于为什么会用<code>8KB</code>作为<code>存储单元</code>分配，为什么大于<code>8KB</code>按照大内存分配策略，在下面<code>Buffer</code>内存分配机制优点有说明。</p> <ul><li>分配大内存</li></ul> <p>还是看上面那张内存分配图，如果需要超过<code>8KB</code>的<code>Buffer</code>对象，将会直接分配一个<code>SlowBuffer</code>对象作为基础单元，这个基础单元将会被这个大<code>Buffer</code>对象独占。</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// Big buffer,just alloc one</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SlowBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的<code>SlowBUffer</code>类实在<code>C++</code>中定义的，虽然引用buffer模块可以访问到它，但是不推荐直接操作它，而是用<code>Buffer</code>替代。这里内部<code>parent</code>属性指向的<code>SlowBuffer</code>对象来自<code>Node</code>自身<code>C++</code>中的定义，是<code>C++</code>层面的<code>Buffer</code>对象，所用内存不在<code>V8</code>的堆中</p> <ul><li>内存分配的限制</li></ul> <p>此外，<code>Buffer</code>单次的内存分配也有限制，而这个限制根据不同操作系统而不同，而这个限制可以看到<code>node_buffer.h</code>里面</p> <div class="language-C extra-class"><pre class="language-c"><code>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> kMaxLength <span class="token operator">=</span>
    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0x3fffffff</span> <span class="token operator">:</span> <span class="token number">0x7fffffff</span><span class="token punctuation">;</span>
</code></pre></div><p>对于32位的操作系统单次可最大分配的内存为1G，对于64位或者更高的为2G。</p> <h4 id="buffer内存分配机制优点"><a href="#buffer内存分配机制优点" class="header-anchor">#</a> buffer内存分配机制优点</h4> <p><code>Buffer</code>真正的内存实在<code>Node</code>的<code>C++</code>层面提供的，<code>JavaScript</code>层面只是使用它。当进行小而频繁的<code>Buffer</code>操作时，采用的是<code>8KB</code>为一个单元的机制进行预先申请和事后分配，使得<code>Javascript</code>到操作系统之间不必有过多的内存申请方面的系统调用。对于大块的<code>Buffer</code>而言(大于<code>8KB</code>)，则直接使用<code>C++</code>层面提供的内存，则无需细腻的分配操作。</p> <h2 id="buffer与stream"><a href="#buffer与stream" class="header-anchor">#</a> Buffer与stream</h2> <h4 id="stream的流动为什么要使用二进制buffer"><a href="#stream的流动为什么要使用二进制buffer" class="header-anchor">#</a> stream的流动为什么要使用二进制Buffer</h4> <p>根据最初代码的打印结果，<code>stream</code>中流动的数据就是<code>Buffer</code>类型，也就是<code>二进制</code>。</p> <p><strong>原因一：</strong></p> <p><code>node</code>官方使用二进制作为数据流动肯定是考虑过很多，比如在上一篇  <a href="https://juejin.im/post/5d25ce36f265da1ba84ab97a" target="_blank" rel="noopener noreferrer">想学Node.js，stream先有必要搞清楚<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文章已经说过，stream主要的设计目的——是为了优化<code>IO操作</code>（<code>文件IO</code>和<code>网络IO</code>），对应后端无论是<code>文件IO</code>还是<code>网络IO</code>，其中包含的数据格式都是未知的，有可能是字符串，音频，视频，网络包等等，即使就是字符串，它的编码格式也是未知的，可能<code>ASC编码</code>，也可能<code>utf-8</code>编码，对于这些未知的情况，还不如直接使用最通用的格式<code>二进制</code>.</p> <p><strong>原因二：</strong></p> <p><code>Buffer</code>对于<code>http</code>请求也会带来性能提升。</p> <p>举一个例子：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'buffer-test.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>   <span class="token comment">// 测试1 ：直接返回二进制数据</span>
        <span class="token comment">// res.end(data.toString())  // 测试2 ：返回字符串数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将代码中的<code>buffer-test</code>文件大小增加到<code>50KB</code>左右，然后使用<code>ab</code>工具测试一下性能，你会发现无论是从<code>吞吐量</code>（Requests per second）还是连接时间上，返回二进制格式比返回字符串格式效率提高很多。为何字符串格式效率低？—— 因为网络请求的数据本来就是二进制格式传输，虽然代码中写的是 <code>response</code> 返回字符串，最终还得再转换为二进制进行传输，多了一步操作，效率当然低了。</p> <h4 id="buffer在stream数据流转充当的角色"><a href="#buffer在stream数据流转充当的角色" class="header-anchor">#</a> Buffer在stream数据流转充当的角色</h4> <p>我们可以把整个<code>流(stream)</code>和<code>Buffer</code>的配合过程看作<code>公交站</code>。在一些公交站，<code>公交车</code>在没有装满乘客前是不会发车的，或者在特定的时刻才会发车。当然，乘客也可能在不同的时间，人流量大小也会有所不同，有人多的时候，有人少的时候，<code>乘客</code>或<code>公交车站</code>都无法控制人流量。</p> <p>不论何时，早到的乘客都必须等待，直到<code>公交车</code>接到指令可以发车。当乘客到站，发现<code>公交车</code>已经装满，或者已经开走，他就必须等待下一班车次。</p> <p>总之，这里总会有一个等待的地方，这个<code>等待的区域</code>就是<code>Node.js</code>中的<code>Buffer</code>，<code>Node.js</code>不能控制数据什么时候传输过来，传输速度，就好像公交车站无法控制人流量一样。他只能决定什么时候发送数据(公交车发车)。如果时间还不到，那么<code>Node.js</code>就会把数据放入<code>Buffer</code>等待区域中，一个在RAM中的地址，直到把他们发送出去进行处理。</p> <p><strong>注意点：</strong></p> <p><code>Buffer</code>虽好也不要瞎用，<code>Buffer</code>与<code>String</code>两者都可以存储字符串类型的数据，但是，<code>String</code>与<code>Buffer</code>不同，在内存分配上面，<code>String</code>直接使用<code>v8堆存储</code>，不用经过<code>c++</code>堆外分配内存，并且<code>Google</code>也对<code>String</code>进行优化，在实际的拼接测速对比中，<code>String</code>比<code>Buffer</code>快。但是<code>Buffer</code>的出现是为了处理二进制以及其他非<code>Unicode</code>编码的数据，所以在处理<code>非utf8</code>数据的时候需要使用到<code>Buffer</code>来处理。</p> <p>今天就分享这么多，如果对分享的内容感兴趣，可以关注公众号「程序员成长指北」，或者加入技术交流群，大家一起讨论。</p> <p>Node系列原创文章:</p> <p><a href="https://juejin.im/post/5d43017be51d4561f40adcf9" target="_blank" rel="noopener noreferrer">深入理解Node.js 中的进程与线程
<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5d25ce36f265da1ba84ab97a" target="_blank" rel="noopener noreferrer">想学Node.js，stream先有必要搞清楚
<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5d5639c7e51d453b5c1218b4" target="_blank" rel="noopener noreferrer">require时，exports和module.exports的区别你真的懂吗<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5d69eef7f265da03f12e70a5" target="_blank" rel="noopener noreferrer">源码解读一文彻底搞懂Events模块
<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5d3f1664e51d4561a34618c1" target="_blank" rel="noopener noreferrer">Node.js 高级进阶之 fs 文件模块学习
<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="关注我"><a href="#关注我" class="header-anchor">#</a> 关注我</h3> <p>觉得不错点个Star，欢迎 加群 互相学习。
<img src="http://img.xiaogangzai.cn/leading.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fish-vuePress/node/stream.html" class="prev">
        node核心模块-stream
      </a></span> <span class="next"><a href="/fish-vuePress/node/processAndThread.html">
        深入理解进程与线程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fish-vuePress/assets/js/app.7db4e227.js" defer></script><script src="/fish-vuePress/assets/js/2.b13c1c09.js" defer></script><script src="/fish-vuePress/assets/js/1.e752e41e.js" defer></script><script src="/fish-vuePress/assets/js/76.8a74b839.js" defer></script>
  </body>
</html>
