<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js中stream模块详解 | 小鱼儿的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="专注前端技术栈分享,从前端到Node.js再到数据库">
    
    <link rel="preload" href="/fish-vuePress/assets/css/0.styles.af3f7b63.css" as="style"><link rel="preload" href="/fish-vuePress/assets/js/app.df5f89c4.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/5.edcfac08.js" as="script"><link rel="preload" href="/fish-vuePress/assets/js/55.b8bbb84d.js" as="script"><link rel="prefetch" href="/fish-vuePress/assets/js/10.b77df3ea.js"><link rel="prefetch" href="/fish-vuePress/assets/js/100.a0d590cb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/101.0c4817e4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/102.78764042.js"><link rel="prefetch" href="/fish-vuePress/assets/js/103.a96d5da9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/104.a28a3fb7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/105.2cec88b8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/106.e18e3f35.js"><link rel="prefetch" href="/fish-vuePress/assets/js/107.3744efd2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/108.ced67a25.js"><link rel="prefetch" href="/fish-vuePress/assets/js/109.f57e1134.js"><link rel="prefetch" href="/fish-vuePress/assets/js/11.97b74358.js"><link rel="prefetch" href="/fish-vuePress/assets/js/110.7c61f586.js"><link rel="prefetch" href="/fish-vuePress/assets/js/111.8e889bff.js"><link rel="prefetch" href="/fish-vuePress/assets/js/112.39a52113.js"><link rel="prefetch" href="/fish-vuePress/assets/js/113.dae7f961.js"><link rel="prefetch" href="/fish-vuePress/assets/js/114.2d597a8d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/115.9553737f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/116.063d8847.js"><link rel="prefetch" href="/fish-vuePress/assets/js/117.13e26da9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/118.3529b5be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/119.8792b07b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/12.3ecb1de5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/120.ed65532d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/121.8c4731cc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/122.4d92baeb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/123.210e85e7.js"><link rel="prefetch" href="/fish-vuePress/assets/js/124.1e513801.js"><link rel="prefetch" href="/fish-vuePress/assets/js/125.d9e5ebae.js"><link rel="prefetch" href="/fish-vuePress/assets/js/126.107bfe67.js"><link rel="prefetch" href="/fish-vuePress/assets/js/127.14edacab.js"><link rel="prefetch" href="/fish-vuePress/assets/js/128.888bc9d6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/129.92bb5f4a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/13.824408f4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/130.e9dca7f9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/131.6bc5662c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/132.1bfdc2ca.js"><link rel="prefetch" href="/fish-vuePress/assets/js/133.99f9ca2f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/134.69c60897.js"><link rel="prefetch" href="/fish-vuePress/assets/js/135.85a830bc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/136.b5627c7c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/137.bcadb89c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/14.ebcb0a05.js"><link rel="prefetch" href="/fish-vuePress/assets/js/15.d3a0b0df.js"><link rel="prefetch" href="/fish-vuePress/assets/js/16.92300b13.js"><link rel="prefetch" href="/fish-vuePress/assets/js/17.e7cd0ca8.js"><link rel="prefetch" href="/fish-vuePress/assets/js/18.9b1b98e6.js"><link rel="prefetch" href="/fish-vuePress/assets/js/19.a6853cc0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/2.3e0c97ad.js"><link rel="prefetch" href="/fish-vuePress/assets/js/20.eb68a5fa.js"><link rel="prefetch" href="/fish-vuePress/assets/js/21.b3e94a5d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/22.7e6803a4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/23.7a26abb3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/24.3a0e2284.js"><link rel="prefetch" href="/fish-vuePress/assets/js/25.2f09a139.js"><link rel="prefetch" href="/fish-vuePress/assets/js/26.fdd61db3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/27.88ee342e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/28.2dba197d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/29.0b89f09e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/3.961388cf.js"><link rel="prefetch" href="/fish-vuePress/assets/js/30.0b4504ec.js"><link rel="prefetch" href="/fish-vuePress/assets/js/31.35a942d3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/32.f6f62b31.js"><link rel="prefetch" href="/fish-vuePress/assets/js/33.1fce904f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/34.86a7f705.js"><link rel="prefetch" href="/fish-vuePress/assets/js/35.a0d3c71e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/36.d4aa17d5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/37.e84a19da.js"><link rel="prefetch" href="/fish-vuePress/assets/js/38.5a3d6630.js"><link rel="prefetch" href="/fish-vuePress/assets/js/39.72e8a86b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/4.deb713bc.js"><link rel="prefetch" href="/fish-vuePress/assets/js/40.171e086b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/41.3d3d2a08.js"><link rel="prefetch" href="/fish-vuePress/assets/js/42.1b56fbe9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/43.55d66008.js"><link rel="prefetch" href="/fish-vuePress/assets/js/44.1f65c599.js"><link rel="prefetch" href="/fish-vuePress/assets/js/45.bd0206b1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/46.aafec962.js"><link rel="prefetch" href="/fish-vuePress/assets/js/47.ac94a28e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/48.2a025aa5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/49.469aaa8c.js"><link rel="prefetch" href="/fish-vuePress/assets/js/50.08274f17.js"><link rel="prefetch" href="/fish-vuePress/assets/js/51.9b109d30.js"><link rel="prefetch" href="/fish-vuePress/assets/js/52.85094941.js"><link rel="prefetch" href="/fish-vuePress/assets/js/53.610ff2c3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/54.1441c891.js"><link rel="prefetch" href="/fish-vuePress/assets/js/56.440ddff2.js"><link rel="prefetch" href="/fish-vuePress/assets/js/57.844af420.js"><link rel="prefetch" href="/fish-vuePress/assets/js/58.3394b61f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/59.5e352a87.js"><link rel="prefetch" href="/fish-vuePress/assets/js/6.81d396d4.js"><link rel="prefetch" href="/fish-vuePress/assets/js/60.5ae989c0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/61.0864cf11.js"><link rel="prefetch" href="/fish-vuePress/assets/js/62.c7442a3b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/63.d893bc29.js"><link rel="prefetch" href="/fish-vuePress/assets/js/64.6da0341b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/65.e2789671.js"><link rel="prefetch" href="/fish-vuePress/assets/js/66.5b4f4293.js"><link rel="prefetch" href="/fish-vuePress/assets/js/67.a0798723.js"><link rel="prefetch" href="/fish-vuePress/assets/js/68.53f11a09.js"><link rel="prefetch" href="/fish-vuePress/assets/js/69.63cb2a8a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/7.6897ca43.js"><link rel="prefetch" href="/fish-vuePress/assets/js/70.804547f9.js"><link rel="prefetch" href="/fish-vuePress/assets/js/71.5787158b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/72.946799be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/73.9d9e52b5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/74.28bafc8a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/75.bd946076.js"><link rel="prefetch" href="/fish-vuePress/assets/js/76.a566a607.js"><link rel="prefetch" href="/fish-vuePress/assets/js/77.3e7bfce0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/78.ec1d52b5.js"><link rel="prefetch" href="/fish-vuePress/assets/js/79.492d0e3b.js"><link rel="prefetch" href="/fish-vuePress/assets/js/8.49a8a0b3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/80.f68ea700.js"><link rel="prefetch" href="/fish-vuePress/assets/js/81.a15fa2be.js"><link rel="prefetch" href="/fish-vuePress/assets/js/82.786ff7c0.js"><link rel="prefetch" href="/fish-vuePress/assets/js/83.6b9d4900.js"><link rel="prefetch" href="/fish-vuePress/assets/js/84.48c296d1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/85.567505d3.js"><link rel="prefetch" href="/fish-vuePress/assets/js/86.1b6fdd4e.js"><link rel="prefetch" href="/fish-vuePress/assets/js/87.90cefee1.js"><link rel="prefetch" href="/fish-vuePress/assets/js/88.f7c32624.js"><link rel="prefetch" href="/fish-vuePress/assets/js/89.0f22b52a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/9.7a3a195f.js"><link rel="prefetch" href="/fish-vuePress/assets/js/90.b23071bb.js"><link rel="prefetch" href="/fish-vuePress/assets/js/91.9b06412d.js"><link rel="prefetch" href="/fish-vuePress/assets/js/92.44c6f292.js"><link rel="prefetch" href="/fish-vuePress/assets/js/93.ced630dd.js"><link rel="prefetch" href="/fish-vuePress/assets/js/94.c5d880af.js"><link rel="prefetch" href="/fish-vuePress/assets/js/95.7ea00f99.js"><link rel="prefetch" href="/fish-vuePress/assets/js/96.08a9387a.js"><link rel="prefetch" href="/fish-vuePress/assets/js/97.7cf3b129.js"><link rel="prefetch" href="/fish-vuePress/assets/js/98.92843a37.js"><link rel="prefetch" href="/fish-vuePress/assets/js/99.3fad2047.js">
    <link rel="stylesheet" href="/fish-vuePress/assets/css/0.styles.af3f7b63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fish-vuePress/" class="home-link router-link-active"><!----> <span class="site-name">小鱼儿的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link">
  webpack
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fish-vuePress/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/fish-vuePress/node-quick/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/fish-vuePress/webframe/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/fish-vuePress/vue-quick/" class="nav-link">
  快速掌握vue
</a></div><div class="nav-item"><a href="/fish-vuePress/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/fish-vuePress/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/fish-vuePress/webpack/" class="nav-link">
  webpack
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fish-vuePress/node-quick/promise.html" class="sidebar-link">promise原理手写</a></li><li><a href="/fish-vuePress/node-quick/eventLoop.html" class="sidebar-link">异步&amp;事件环</a></li><li><a href="/fish-vuePress/node-quick/node.html" class="sidebar-link">node基本概念</a></li><li><a href="/fish-vuePress/node-quick/node-modules.html" class="sidebar-link">node中的模块</a></li><li><a href="/fish-vuePress/node-quick/npm.html" class="sidebar-link">npm常用命令</a></li><li><a href="/fish-vuePress/node-quick/path.html" class="sidebar-link">node核心模块-path</a></li><li><a href="/fish-vuePress/node-quick/buffer.html" class="sidebar-link">Buffer的应用</a></li><li><a href="/fish-vuePress/node-quick/fs.html" class="sidebar-link">fs模块</a></li><li><a href="/fish-vuePress/node-quick/stream.html" aria-current="page" class="active sidebar-link">stream模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_1-流的概念" class="sidebar-link">1.流的概念</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_2-如何实现拷贝文件" class="sidebar-link">2.如何实现拷贝文件</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_3-可读流" class="sidebar-link">3.可读流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_1-使用" class="sidebar-link">1.使用</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_2-可读流实现" class="sidebar-link">2.可读流实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_4-可写流" class="sidebar-link">4.可写流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_1-使用-2" class="sidebar-link">1.使用</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_2-可写流的实现" class="sidebar-link">2.可写流的实现</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#链表优化缓存区链表" class="sidebar-link">链表优化缓存区链表</a></li></ul></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_5-详细讲解" class="sidebar-link">5. 详细讲解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_1-stream定义" class="sidebar-link">1.stream定义</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_2-为什么要学习stream" class="sidebar-link">2. 为什么要学习stream</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#视频播放例子" class="sidebar-link" style="padding-left:3rem;">视频播放例子</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#读取大文件data的例子" class="sidebar-link" style="padding-left:3rem;">读取大文件data的例子</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_2-stream流转过程" class="sidebar-link">2. stream流转过程</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#stream从哪里来-soucre" class="sidebar-link" style="padding-left:3rem;">stream从哪里来-soucre</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#连接水桶的管道-pipe" class="sidebar-link" style="padding-left:3rem;">连接水桶的管道-pipe</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#stream到哪里去-dest" class="sidebar-link" style="padding-left:3rem;">stream到哪里去-dest</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_3-stream应用场景" class="sidebar-link">3.stream应用场景</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#介绍一个压力测试的小工具" class="sidebar-link" style="padding-left:3rem;">介绍一个压力测试的小工具</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#get请求中应用stream" class="sidebar-link" style="padding-left:3rem;">get请求中应用stream</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#post中使用stream" class="sidebar-link" style="padding-left:3rem;">post中使用stream</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_4-post与get使用stream总结" class="sidebar-link">4.post与get使用stream总结</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#在文件操作中使用stream" class="sidebar-link" style="padding-left:3rem;">在文件操作中使用stream</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#前端一些打包工具的底层实现" class="sidebar-link" style="padding-left:3rem;">前端一些打包工具的底层实现</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_5-stream的种类" class="sidebar-link">5.stream的种类</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_6-stream有什么弊端" class="sidebar-link">6.stream有什么弊端</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_7-stream的常见类库" class="sidebar-link">7.stream的常见类库</a></li><li class="sidebar-sub-header"><a href="/fish-vuePress/node-quick/stream.html#_8-总结" class="sidebar-link">8.总结</a></li></ul></li></ul></li><li><a href="/fish-vuePress/node-quick/linkedList.html" class="sidebar-link">什么是链表</a></li><li><a href="/fish-vuePress/node-quick/tree.html" class="sidebar-link">树</a></li><li><a href="/fish-vuePress/node-quick/http.html" class="sidebar-link">HTTP核心概念</a></li><li><a href="/fish-vuePress/node-quick/http-header.html" class="sidebar-link">HTTP中Header应用</a></li><li><a href="/fish-vuePress/node-quick/Cookie.html" class="sidebar-link">Cookie/Session/JWT</a></li><li><a href="/fish-vuePress/node-quick/express.html" class="sidebar-link">Express应用+原理</a></li><li><a href="/fish-vuePress/node-quick/koa.html" class="sidebar-link">koa</a></li><li><a href="/fish-vuePress/node-quick/node-loop.html" class="sidebar-link">node中的进程和线程</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-流的概念"><a href="#_1-流的概念" class="header-anchor">#</a> 1.流的概念</h2> <ul><li>流是一组有序的，有起点和终点的字节数据传输手段</li> <li>它不关心文件的整体内容，只关注是否从文件中读到了数据，以及读到数据之后的处理</li> <li>流是一个抽象接口，被 Node 中的很多对象所实现。比如HTTP 服务器request和response对象都是流。</li></ul> <h2 id="_2-如何实现拷贝文件"><a href="#_2-如何实现拷贝文件" class="header-anchor">#</a> 2.如何实现拷贝文件</h2> <p>基于fs实现 读一点写一点 -缺陷耦合严重</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> <span class="token constant">BUFFER_LENGTH</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> read_position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> write_positon <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token constant">BUFFER_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rfd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> wfd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>rfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">BUFFER_LENGTH</span><span class="token punctuation">,</span> read_position<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bytesRead</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bytesRead<span class="token punctuation">,</span>write_positon<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>written</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            read_position <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
                            write_positon <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
                            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                        fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>wfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                   
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">copy</span><span class="token punctuation">(</span><span class="token string">'./2.js'</span><span class="token punctuation">,</span> <span class="token string">'./xxx.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'copy-success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_3-可读流"><a href="#_3-可读流" class="header-anchor">#</a> 3.可读流</h2> <h3 id="_1-使用"><a href="#_1-使用" class="header-anchor">#</a> 1.使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> createReadStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ReadStream'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'1.text'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    flags<span class="token operator">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span>
    encoding<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    autoClose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">//从哪里读到哪里</span>
    highWaterMark<span class="token operator">:</span> <span class="token number">2</span> <span class="token comment">//如果不写 默认是64*1024 一次读取多少位</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// console.log(rs);</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//拼接2进制</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//控制速率 rs.resume(); 恢复</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//恢复读写</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-可读流实现"><a href="#_2-可读流实现" class="header-anchor">#</a> 2.可读流实现</h3> <p>ReadStream 内部实现了pipe</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ReadStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'r'</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//从什么地方开始读取</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> options<span class="token punctuation">.</span>end <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">//到什么地方结束</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">64</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment">//水位线 控制一次读取多少个字节</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//默认就调用开启事件</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span> <span class="token comment">//offset可以根据每次读取的位置发生变化</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//默认是非流动模式</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span> <span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'data'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token comment">//管道流 -- 传入一个可写流 可以实现边读边写</span>
   <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>
   <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>flowing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//继续读取</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
       fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span> <span class="token comment">//将文件描述符保存起来</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!=</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//保证fd一定存在</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取完了 通知我一下</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//fd 一定存在 Buffer是内存</span>
     <span class="token keyword">const</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 2 真正要读取的个数 4 - 2  2</span>
     <span class="token keyword">let</span> howMuchtoRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span>
     fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> howMuchtoRead<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bytesRead</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment">//bytesRead 真正要读取的个数</span>
    <span class="token comment">//    console.log('bytesRead', bytesRead);</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span> <span class="token comment">//方便下次读取</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//可能实际只有3个字节 highWaterMark &gt; 3 </span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flowing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ReadStream<span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-可写流"><a href="#_4-可写流" class="header-anchor">#</a> 4.可写流</h2> <h3 id="_1-使用-2"><a href="#_1-使用-2" class="header-anchor">#</a> 1.使用</h3> <p>异步写入 多次写入要有一个缓存区 (链表)因为不能同时操作一个文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CreateWriteStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./CreateWriteStream.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateWriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'text.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    flags<span class="token operator">:</span> <span class="token string">'w'</span><span class="token punctuation">,</span>
    encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
    autoClose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    highWaterMark<span class="token operator">:</span> <span class="token number">5</span><span class="token comment">//默认16k </span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//ws 可写流</span>
<span class="token comment">//ws.write() ws.end(); ws.on('open)</span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//如果写入的字节大于highWaterMark 会返回一个标识 写入的字节大于2 就返回false</span>
        flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token operator">+</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异步写入 多次写入要有一个缓存区 (链表)因为不能同时操作一个文件</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> flag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//抽干 当我们的内容达到预期后 超过预期时会触发此方法（必须等这么内容写到文件中才执行）</span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等写完第一个 需要再写第二个</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'清空'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-可写流的实现"><a href="#_2-可写流的实现" class="header-anchor">#</a> 2.可写流的实现</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> Queue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./queue'</span><span class="token punctuation">)</span>
<span class="token comment">// class Writeable extends EventEmitter{</span>
<span class="token comment">//     constructor(options) {</span>
<span class="token comment">//         super();</span>
        
<span class="token comment">//     }</span>
<span class="token comment">//   write() {</span>
<span class="token comment">//      this._write();</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
<span class="token keyword">class</span> <span class="token class-name">WriteStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options <span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'w'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">16</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//要判断第一次写入 还是第二次写入</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//用来描述当前是否有正在写入的操作</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//默然是否触发drain事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//需要统计的长度</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//每次写入的偏移量</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用来实现缓存的</span>
    <span class="token punctuation">}</span>
    <span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">,</span><span class="token function-variable function">cb</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断是真的写入 还是需要放到缓存中</span>
      <span class="token comment">//用户调用write 写入发数据可能是stringOrBuffer</span>
      chunk <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">?</span> chunk <span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//超过预期 达到预期 就改变触发drain</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>writing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              chunk<span class="token punctuation">,</span>
              encoding<span class="token punctuation">,</span>
              cb
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示正在写入</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span>chunk<span class="token punctuation">,</span>encoding<span class="token punctuation">,</span>cb<span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//缓存都清掉了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>needDrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span> <span class="token comment">//将文件描述符保存起来</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span>encoding<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//fs._write</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>chunk<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>chunk<span class="token punctuation">.</span>length<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>offset<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> written</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> written<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">+=</span> written<span class="token punctuation">;</span>
          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WriteStream<span class="token punctuation">;</span>
</code></pre></div><h3 id="链表优化缓存区链表"><a href="#链表优化缓存区链表" class="header-anchor">#</a> 链表优化缓存区<a href="/fish-vuePress/node-quick/linkedList.html"><code>链表</code></a></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> LinkList <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./linkList'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Queue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">offer</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//入队列</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ll<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ll<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Queue
</code></pre></div><h2 id="_5-详细讲解"><a href="#_5-详细讲解" class="header-anchor">#</a> 5. 详细讲解</h2> <h3 id="_1-stream定义"><a href="#_1-stream定义" class="header-anchor">#</a> 1.stream定义</h3> <p>流的英文<code>stream</code>，流（Stream）是一个抽象的数据接口，<code>Node.js</code>中很多对象都实现了流，流是<code>EventEmitter</code>对象的一个实例，总之它是会冒数据（以 <code>Buffer</code> 为单位），或者能够吸收数据的东西，它的本质就是让数据流动起来。
可能看一张图会更直观：</p> <p><img src="http://img.xiaogangzai.cn/16bdbb113be0341a.jpg" alt="水桶管道流转图"></p> <p>注意：<code>stream</code>不是node.js独有的概念，而是一个操作系统最基本的操作方式，只不过node.js有API支持这种操作方式。linux命令的|就是<code>stream</code>。</p> <h3 id="_2-为什么要学习stream"><a href="#_2-为什么要学习stream" class="header-anchor">#</a> 2. 为什么要学习stream</h3> <h4 id="视频播放例子"><a href="#视频播放例子" class="header-anchor">#</a> 视频播放例子</h4> <p>小伙伴们肯定都在线看过电影，对比定义中的图-<code>水桶管道流转图</code>，<code>source</code>就是服务器端的视频，<code>dest</code>就是你自己的播放器(或者浏览器中的flash和h5 video)。大家想一下，看电影的方式就如同上面的图管道换水一样，一点点从服务端将视频流动到本地播放器，一边流动一边播放，最后流动完了也就播放完了。</p> <p>说明：视频播放的这个例子，如果我们不使用管道和流动的方式，直接先从服务端加载完视频文件，然后再播放。会造成很多问题</p> <ol><li>因内存占有太多而导致系统卡顿或者崩溃</li> <li>因为我们的网速 内存 cpu运算速度都是有限的，而且还要有多个程序共享使用，一个视频文件加载完可能有几个g那么大。</li></ol> <h4 id="读取大文件data的例子"><a href="#读取大文件data的例子" class="header-anchor">#</a> 读取大文件data的例子</h4> <p><strong>有一个这样的需求，想要读取大文件data的例子</strong></p> <p>使用文件读取</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用文件读取这段代码语法上并没有什么问题，但是如果data.txt文件非常大的话，到了几百M，在响应大量用户并发请求的时候，程序可能会消耗大量的内存，这样可能造成用户连接缓慢的问题。而且并发请求过大的话，服务器内存开销也会很大。这时候我们来看一下用<code>stream</code>实现。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这一行有改动</span>
    stream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这一行有改动</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用stream就可以不需要把文件全部读取了再返回，而是一边读取一边返回，数据通过管道流动给客户端，真的减轻了服务器的压力。</p> <p>看了两个例子我想小伙伴们应该知道为<code>什么要使用stream</code>了吧！因为一次性读取,操作大文件，内存和网络是吃不消的，因此要让数据流动起来，一点点的进行操作。</p> <h3 id="_2-stream流转过程"><a href="#_2-stream流转过程" class="header-anchor">#</a> 2. stream流转过程</h3> <p>再次看这张<code>水桶管道流转图</code></p> <p><img src="http://img.xiaogangzai.cn/16bdbb113be0341a.jpg" alt="水桶管道流转图"></p> <p>图中可以看出，<code>stream</code>整个流转过程包括source，dest，还有连接二者的管道pipe(stream的核心)，分别介绍三者来带领大家搞懂stream流转过程。</p> <h4 id="stream从哪里来-soucre"><a href="#stream从哪里来-soucre" class="header-anchor">#</a> stream从哪里来-soucre</h4> <p><code>stream</code>的常见来源方式有三种：</p> <ol><li>从控制台输入</li> <li><code>http</code>请求中的<code>request</code></li> <li>读取文件</li></ol> <p>这里先说一下<code>从控制台输入</code>这种方式，2和3两种方式<code>stream应用场景</code>章节会有详细的讲解。</p> <p>看一段<code>process.stdin</code>的代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stream by stdin'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stream by stdin'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//控制台输入koalakoala后输出结果</span>
stream by stdin <span class="token operator">&lt;</span>Buffer <span class="token number">6</span>b <span class="token number">6</span>f <span class="token number">61</span> <span class="token number">6</span>c <span class="token number">61</span> <span class="token number">6</span>b <span class="token number">6</span>f <span class="token number">61</span> <span class="token number">6</span>c <span class="token number">61</span> <span class="token number">0</span>a<span class="token operator">&gt;</span>
stream by stdin koalakoala
</code></pre></div><p>运行上面代码：然后从控制台输入任何内容都会被<code>data</code> 事件监听到，<code>process.stdin</code>就是一个<code>stream</code>对象,data
是<code>stream</code>对象用来监听数据传入的一个自定义函数，通过输出结果可看出<code>process.stdin</code>是一个stream对象。</p> <p>说明： <code>stream</code>对象可以监听<code>&quot;data&quot;</code>,<code>&quot;end&quot;</code>,<code>&quot;opne&quot;</code>,<code>&quot;close&quot;</code>,<code>&quot;error&quot;</code>等事件。<code>node.js</code>中监听自定义事件使用<code>.on</code>方法，例如<code>process.stdin.on(‘data’,…)</code>, <code>req.on(‘data’,…)</code>,通过这种方式，能很直观的监听到<code>stream</code>数据的传入和结束</p> <h4 id="连接水桶的管道-pipe"><a href="#连接水桶的管道-pipe" class="header-anchor">#</a> 连接水桶的管道-pipe</h4> <p>从水桶管道流转图中可以看到，在<code>source</code>和<code>dest</code>之间有一个连接的管道<code>pipe</code>,它的基本语法是<code>source.pipe(dest)</code>，<code>source</code>和<code>dest</code>就是通过pipe连接，让数据从<code>source</code>流向了<code>dest</code>。</p> <h4 id="stream到哪里去-dest"><a href="#stream到哪里去-dest" class="header-anchor">#</a> stream到哪里去-dest</h4> <p>stream的常见输出方式有三种：</p> <ol><li>输出控制台</li> <li><code>http</code>请求中的<code>response</code></li> <li>写入文件</li></ol> <h3 id="_3-stream应用场景"><a href="#_3-stream应用场景" class="header-anchor">#</a> 3.stream应用场景</h3> <p><code>stream</code>的应用场景主要就是处理<code>IO</code>操作，而<code>http请求</code>和<code>文件操作</code>都属于<code>IO</code>操作。这里再提一下<code>stream</code>的本质——由于一次性<code>IO</code>操作过大，硬件开销太多，影响软件运行效率，因此将<code>IO</code>分批分段进行操作，让数据像水管一样流动起来，直到流动完成，也就是操作完成。下面对几个常用的应用场景分别进行介绍</p> <h4 id="介绍一个压力测试的小工具"><a href="#介绍一个压力测试的小工具" class="header-anchor">#</a> 介绍一个压力测试的小工具</h4> <p>一个对网络请求做压力测试的工具<code>ab</code>，<code>ab</code> 全称 <code>Apache bench</code> ，是 <code>Apache</code> 自带的一个工具，因此使用 <code>ab</code> 必须要安装 <code>Apache</code> 。mac os 系统自带 <code>Apache</code> ，<code>windows</code>用户视自己的情况进行安装。运行<code>ab</code> 之前先启动 <code>Apache</code> ，<code>mac os</code> 启动方式是 <code>sudo apachectl start</code> 。</p> <p>Apache bench对应参数的详细学习地址，有兴趣的可以看一下
<a href="https://ruby-china.org/topics/13870" target="_blank" rel="noopener noreferrer">Apache bench对应参数的详细学习地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>介绍这个小工具的目的是对下面几个场景可以进行直观的测试，看出使用stream带来了哪些性能的提升。</p> <h4 id="get请求中应用stream"><a href="#get请求中应用stream" class="header-anchor">#</a> get请求中应用stream</h4> <p>这样一个需求：</p> <p>使用node.js实现一个http请求，读取data.txt文件，创建一个服务，监听8000端口，读取文件后返回给客户端，讲get请求的时候用一个常规文件读取与其做对比，请看下面的例子。</p> <ul><li>常规使用文件读取返回给客户端response例子 ，文件命名为<code>getTest1.js</code></li></ul> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// getTest.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">;</span> <span class="token comment">// 获取请求方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// get 请求方法判断</span>
        <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>使用stream返回给客户端response
将上面代码做部分修改，文件命名为<code>getTest2.js</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// getTest2.js</span>
<span class="token comment">// 主要展示改动的部分</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">;</span> <span class="token comment">// 获取请求方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// get 请求</span>
        <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将 res 作为 stream 的 dest</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于下面get请求中使用stream的例子，会不会有些小伙伴提出质疑，难道response也是一个stream对象，是的没错,对于那张<code>水桶管道流转图</code>,response就是一个dest。</p> <p>虽然get请求中可以使用stream，但是相比直接file文件读取<code>·res.end(data)</code>有什么好处呢？这时候我们刚才推荐的压力测试小工具就用到了。<code>getTest1</code>和<code>getTest2</code>两段代码，将<code>data.txt</code>内容增加大一些，使用<code>ab</code>工具进行测试，运行命令<code>ab -n 100 -c 100 http://localhost:8000/</code>，其中<code>-n 100</code>表示先后发送100次请求，<code>-c 100</code>表示一次性发送的请求数目为100个。对比结果分析使用stream后，有非常大的性能提升，小伙伴们可以自己实际操作看一下。</p> <h4 id="post中使用stream"><a href="#post中使用stream" class="header-anchor">#</a> post中使用stream</h4> <p>一个通过post请求微信小程序的地址生成二维码的需求。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/*
* 微信生成二维码接口
* params src 微信url / 其他图片请求链接
* params localFilePath: 本地路径
* params data: 微信请求参数
* */</span>
<span class="token keyword">const</span> <span class="token function-variable function">downloadFile</span><span class="token operator">=</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> localFilePath<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
                    uri<span class="token operator">:</span> src<span class="token punctuation">,</span>
                    json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    body<span class="token operator">:</span> data
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">request</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'wxdownloadFile error: '</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看这段使用了stream的代码，为本地文件对应的路径创建一个stream对象，然后直接<code>.pipe(ws)</code>,将post请求的数据流转到这个本地文件中，这种stream的应用在node后端开发过程中还是比较常用的。</p> <h3 id="_4-post与get使用stream总结"><a href="#_4-post与get使用stream总结" class="header-anchor">#</a> 4.post与get使用stream总结</h3> <p>request和reponse一样，都是stream对象，可以使用stream的特性，二者的区别在于，我们再看一下<code>水桶管道流转图</code>，</p> <p><img src="http://img.xiaogangzai.cn/16bdbb113be0341a.jpg" alt="">
request是source类型，是图中的源头，而response是dest类型，是图中的目的地。</p> <h4 id="在文件操作中使用stream"><a href="#在文件操作中使用stream" class="header-anchor">#</a> 在文件操作中使用stream</h4> <p>一个文件拷贝的例子</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment">// 两个文件名</span>
<span class="token keyword">const</span> fileName1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fileName2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data-bak.txt'</span><span class="token punctuation">)</span>
<span class="token comment">// 读取文件的 stream 对象</span>
<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName1<span class="token punctuation">)</span>
<span class="token comment">// 写入文件的 stream 对象</span>
<span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>fileName2<span class="token punctuation">)</span>
<span class="token comment">// 通过 pipe执行拷贝，数据流转</span>
readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span>
<span class="token comment">// 数据读取完成监听，即拷贝完成</span>
readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拷贝完成'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>看了这段代码，发现是不是拷贝好像很简单，创建一个可读数据流<code>readStream</code>，一个可写数据流<code>writeStream</code>,然后直接通过<code>pipe</code>管道把数据流转过去。这种使用stream的拷贝相比存文件的读写实现拷贝，性能要增加很多，所以小伙伴们在遇到文件操作的需求的时候，尽量先评估一下是否需要使用<code>stream</code>实现。</p> <h4 id="前端一些打包工具的底层实现"><a href="#前端一些打包工具的底层实现" class="header-anchor">#</a> 前端一些打包工具的底层实现</h4> <p>目前一些比较火的<code>前端打包构建工具</code>，都是通过<code>node.js</code>编写的，打包和构建的过程肯定是文件频繁操作的过程，离不来<code>stream</code>,例如现在比较火的<code>gulp</code>,有兴趣的小伙伴可以去看一下源码。</p> <h3 id="_5-stream的种类"><a href="#_5-stream的种类" class="header-anchor">#</a> 5.stream的种类</h3> <ul><li><code>Readable Stream</code> 可读数据流</li> <li><code>Writeable Stream</code> 可写数据流</li> <li><code>Duplex Stream</code> 双向数据流，可以同时读和写</li> <li><code>Transform Stream</code> 转换数据流，可读可写，同时可以转换（处理）数据(不常用)</li></ul> <p>之前的文章都是围绕前两种可读数据流和可写数据流，第四种流不太常用，需要的小伙伴网上搜索一下，接下来对第三种数据流Duplex Stream 说明一下。</p> <p><code>Duplex Stream</code> 双向的，既可读，又可写。
<code>Duplex streams</code>同时实现了 <code>Readable</code>和<code>Writable</code> 接口。 <code>Duplex streams</code>的例子包括</p> <ul><li><code>tcp sockets</code></li> <li><code>zlib streams</code></li> <li><code>crypto streams</code>
我在项目中还未使用过双工流，一些Duplex Stream的内容可以参考这篇文章<a href="https://www.cnblogs.com/dolphinX/p/6376615.html" target="_blank" rel="noopener noreferrer">NodeJS Stream 双工流<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="_6-stream有什么弊端"><a href="#_6-stream有什么弊端" class="header-anchor">#</a> 6.stream有什么弊端</h3> <ul><li>用 <code>rs.pipe(ws)</code> 的方式来写文件并不是把 rs 的内容 <code>append</code> 到 ws 后面，而是直接用 rs 的内容覆盖 ws 原有的内容</li> <li>已结束/关闭的流不能重复使用，必须重新创建数据流</li> <li><code>pipe</code> 方法返回的是目标数据流，如 <code>a.pipe(b)</code> 返回的是 b，因此监听事件的时候请注意你监听的对象是否正确</li> <li>如果你要监听多个数据流，同时你又使用了 <code>pipe</code> 方法来串联数据流的话，你就要写成：
代码实例：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code> data
        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-stream的常见类库"><a href="#_7-stream的常见类库" class="header-anchor">#</a> 7.stream的常见类库</h3> <ul><li><p><a href="https://github.com/dominictarr/event-stream" target="_blank" rel="noopener noreferrer">event-stream <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>用起来有函数式编程的感觉</p></li> <li><p><a href="https://github.com/sindresorhus/awesome-nodejs#streams" target="_blank" rel="noopener noreferrer">awesome-nodejs#streams<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>也是一个不错的第三方stream库，有兴趣的小伙伴可以github看一下</p></li></ul> <h3 id="_8-总结"><a href="#_8-总结" class="header-anchor">#</a> 8.总结</h3> <p>看完了这篇文章是不是对stream有了一定的了解，并且知道了node对于文件处理还是有完美的解决方案的。本文中三次展示了<code>水桶管道流转图</code>,总要的事情说三遍希望小伙伴们记住它，除了以上内容小伙伴们会不会有一些思考，比如</p> <ol><li>stream数据流转具体内容是什么呢？二进制还是<code>string</code>类型还是其他类型,该类型为stream带来了什么好处？</li> <li>水桶管道流转图中的水管，也就是<code>pipe</code>函数什么时候触发的呢？在什么情况下触流转发？底层机制是什么？
上面的疑问(由于篇幅过长拆分为两篇)会在我<code>stream</code>的第二篇文章为大家详细讲解。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fish-vuePress/node-quick/fs.html" class="prev">
        fs模块
      </a></span> <span class="next"><a href="/fish-vuePress/node-quick/linkedList.html">
        什么是链表
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fish-vuePress/assets/js/app.df5f89c4.js" defer></script><script src="/fish-vuePress/assets/js/5.edcfac08.js" defer></script><script src="/fish-vuePress/assets/js/55.b8bbb84d.js" defer></script>
  </body>
</html>
